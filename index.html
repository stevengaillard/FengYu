<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structural Anchor Analysis</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23004a99%22/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23004a99%22/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        eng: {
                            primary: '#004a99',
                            secondary: '#f0f2f5',
                            dark: '#1e293b',
                            success: '#10b981',
                            danger: '#ef4444',
                            warning: '#f59e0b'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .calc-input {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .math-symbol {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* PRINT SPECIFIC STYLES */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            /* Hide the web app UI */
            #root, #auth-modal, nav {
                display: none !important;
            }

            /* Show the print staging area */
            #print-staging {
                display: block !important;
                background: white;
                color: black;
                font-family: 'Arial', sans-serif;
                font-size: 10pt;
            }

            /* Force background colors to print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Page Break Logic */
            .page-break {
                break-before: page;
                page-break-before: always;
                margin-top: 1rem;
                display: block;
                clear: both;
            }

            table, tr, td, th {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Report Styling */
            h1 {
                color: #004a99;
                font-size: 18pt;
                margin-bottom: 5px;
                font-weight: bold;
                border-bottom: 2px solid #004a99;
                padding-bottom: 5px;
            }

            h2 {
                color: #333;
                font-size: 12pt;
                margin-top: 15px;
                margin-bottom: 5px;
                background: #eee;
                padding: 3px 8px;
                font-weight: bold;
            }

            h3 {
                color: #004a99;
                font-size: 11pt;
                margin-top: 10px;
                margin-bottom: 5px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 2px;
            }

            h4 {
                color: #555;
                font-size: 10pt;
                margin-top: 8px;
                margin-bottom: 3px;
                text-transform: uppercase;
                font-weight: bold;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
                font-size: 9pt;
            }

            th {
                background-color: #004a99;
                color: white;
                padding: 4px;
                text-align: left;
                font-weight: bold;
            }

            td {
                border: 1px solid #ddd;
                padding: 4px;
                vertical-align: middle;
            }

            tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            .pass { color: green; font-weight: bold; }
            .fail { color: red; font-weight: bold; }
            
            .report-footer {
                margin-top: 20px;
                border-top: 1px solid #ccc;
                padding-top: 5px;
                font-size: 7pt;
                color: #888;
                text-align: center;
                width: 100%;
            }
        }

        /* Hide print staging on normal screen */
        #print-staging {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans">

    <div id="root" class="min-h-screen flex flex-col">

        <!-- Navbar -->
        <nav class="bg-eng-primary text-white shadow-md sticky top-0 z-50">
            <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fa-solid fa-ruler-combined text-xl"></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight" data-i18n="app_title">Anchor Analysis</h1>
                        <p class="text-xs opacity-80 font-light" data-i18n="app_subtitle">ACI 318-19 Chapter 17 Compliance</p>
                    </div>
                </div>
                <div id="auth-section" class="flex items-center gap-2">
                    <button onclick="toggleLanguage()" class="bg-blue-800 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold border border-blue-600 transition">
                        <i class="fa-solid fa-language mr-1"></i> <span id="lang-label">中文</span>
                    </button>
                    <button id="login-btn" class="bg-white text-eng-primary px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-gray-100 transition" data-i18n="btn_login">
                        <i class="fa-solid fa-user mr-2"></i>Login
                    </button>
                    <div id="user-info" class="hidden flex items-center space-x-4">
                        <span id="user-email" class="text-xs opacity-90 hidden sm:inline font-mono bg-blue-900 px-2 py-1 rounded"></span>
                        <button id="logout-btn" class="text-sm hover:text-gray-200"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow max-w-5xl mx-auto w-full p-4 space-y-6">

            <!-- Auth Modal -->
            <div id="auth-modal" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
                <div class="bg-white rounded-lg shadow-2xl p-8 w-11/12 max-w-sm border-t-4 border-eng-primary">
                    <h2 class="text-2xl font-bold mb-2 text-center text-eng-primary" data-i18n="modal_title">Access Portal</h2>
                    <p class="text-gray-500 mb-4 text-center text-sm" data-i18n="modal_desc">Sign in to sync your data across devices.</p>

                    <div class="space-y-3 mb-4">
                        <input type="email" id="auth-email" placeholder="Email" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-eng-primary outline-none">
                        <input type="password" id="auth-password" placeholder="Password" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-eng-primary outline-none">
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button id="email-login-btn" class="flex-1 bg-eng-primary text-white py-2 rounded text-sm font-bold hover:bg-blue-800 transition" data-i18n="btn_login_submit">Login</button>
                        <button id="email-register-btn" class="flex-1 bg-white text-eng-primary border border-eng-primary py-2 rounded text-sm font-bold hover:bg-blue-50 transition" data-i18n="btn_register">Register</button>
                    </div>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-xs">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <button id="guest-login" class="w-full bg-gray-200 text-gray-700 py-2 rounded mb-3 text-sm font-semibold hover:bg-gray-300 transition shadow-sm" data-i18n="btn_guest">
                        Continue as Guest
                    </button>
                    <p id="auth-error" class="text-xs text-red-500 text-center hidden mt-2"></p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-300 bg-white rounded-t-lg shadow-sm">
                <button onclick="switchTab('calculator')" id="tab-calculator" class="flex-1 py-4 text-center font-bold text-eng-primary border-b-4 border-eng-primary transition-colors">
                    <i class="fa-solid fa-calculator mr-2"></i><span data-i18n="tab_analysis">Analysis</span>
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-4 text-center font-medium text-gray-500 hover:text-eng-primary transition-colors">
                    <i class="fa-solid fa-server mr-2"></i><span data-i18n="tab_database">Database</span>
                </button>
            </div>

            <!-- TAB: CALCULATOR -->
            <div id="view-calculator" class="space-y-6 pb-20">

                <!-- INPUTS -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-gray-100 px-6 py-3 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700"><i class="fa-solid fa-pen-to-square mr-2"></i><span data-i18n="sec_params">Design Parameters</span></h3>
                        <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border">Units: kgf, cm</span>
                    </div>

                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                        <!-- 1. Geometry -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_mat">Material & Geometry</h4>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_fc">Concrete Strength (<span class="math-symbol">f'c</span>)</label>
                                <input type="number" id="fc" value="280" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ha">Wall Thickness (<span class="math-symbol">h<sub>a</sub></span>)</label>
                                <input type="number" id="ha" value="20" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_da">Anchor Diameter (<span class="math-symbol">d<sub>a</sub></span>)</label>
                                <input type="number" id="da" value="1.6" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_hef">Embedment (<span class="math-symbol">h<sub>ef</sub></span>)</label>
                                <input type="number" id="hef" value="12" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>
                            
                            <!-- Steel Inputs -->
                            <div>
                                <label class="text-xs text-gray-500">Steel Ultimate Strength (<span class="math-symbol">f<sub>uta</sub></span>)</label>
                                <input type="number" id="futa" value="4100" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-500">Eff. Area (<span class="math-symbol">A<sub>se</sub></span>)</label>
                                    <input type="number" id="ase" value="1.57" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Bear. Area (<span class="math-symbol">A<sub>brg</sub></span>)</label>
                                    <input type="number" id="abrg" value="4.5" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- 2. Spacing -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_space">Spacing & Edge Dist</h4>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_s1">Vertical Spacing (<span class="math-symbol">S<sub>1</sub></span>)</label>
                                <input type="number" id="s1" value="22" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_s2">Horizontal Spacing (<span class="math-symbol">S<sub>2</sub></span>)</label>
                                <input type="number" id="s2" value="15" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca1">Top Edge (<span class="math-symbol">C<sub>a1</sub></span>)</label>
                                <input type="number" id="ca1" value="13" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca1_1">Bottom Edge (<span class="math-symbol">C<sub>a1,1</sub></span>)</label>
                                <input type="number" id="ca1_1" value="35" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca2">Side Edge (<span class="math-symbol">C<sub>a2</sub></span>)</label>
                                <input type="number" id="ca2" value="15" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>
                        </div>

                        <!-- 3. Factors & Conditions -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_factors">Factors & Conditions</h4>

                            <!-- Anchor Type Detailed -->
                            <div>
                                <label class="text-xs text-gray-500">Specific Anchor Type</label>
                                <select id="anchor_type_detailed" class="w-full border border-gray-300 rounded p-2 text-xs" onchange="toggleTypeInputs()">
                                    <option value="cast_headed">Cast-in: Headed Stud/Bolt</option>
                                    <option value="cast_hooked">Cast-in: Hooked Bolt (J/L)</option>
                                    <option value="post_expansion">Post-installed: Expansion</option>
                                    <option value="post_screw">Post-installed: Screw</option>
                                    <option value="post_adhesive">Post-installed: Adhesive (Bonded)</option>
                                </select>
                            </div>

                            <!-- Dynamic Inputs -->
                            <div id="input-hooked" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
                                <label class="text-xs text-gray-700 font-bold">Hook Extension (<span class="math-symbol">e<sub>h</sub></span>) [cm]</label>
                                <input type="number" id="eh" value="5.0" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                            </div>

                            <div id="input-adhesive" class="hidden bg-blue-50 p-2 rounded border border-blue-200">
                                <label class="text-xs text-gray-700 font-bold">Bond Stress (<span class="math-symbol">τ<sub>cr</sub></span>) [kgf/cm²]</label>
                                <input type="number" id="tau" value="14" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs mb-1">
                                <label class="text-xs text-gray-500">Uncracked (<span class="math-symbol">τ<sub>uncr</sub></span>) [kgf/cm²]</label>
                                <input type="number" id="tau_uncr" value="45" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                            </div>

                            <div class="flex items-center space-x-2 my-2">
                                <input type="checkbox" id="is_cracked" class="rounded text-eng-primary focus:ring-eng-primary" checked>
                                <label for="is_cracked" class="text-xs text-gray-700">Cracked Concrete Condition</label>
                            </div>
                            
                            <div class="flex items-center space-x-2 my-2">
                                <input type="checkbox" id="is_seismic" class="rounded text-eng-primary focus:ring-eng-primary">
                                <label for="is_seismic" class="text-xs text-gray-700">Seismic Design Required</label>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_lambda">Lightweight Factor (<span class="math-symbol">λ<sub>a</sub></span>)</label>
                                <select id="lambda_select" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="1.0" data-i18n="opt_lam1">Normal Weight (1.0)</option>
                                    <option value="0.75">All-Lightweight (0.75)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_reinf">Reinforcement Condition</label>
                                <select id="psi_c_V_select" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="1.0" data-i18n="opt_reinf1">None / &lt; D13</option>
                                    <option value="1.2" data-i18n="opt_reinf2">Reinf ≥ D13</option>
                                    <option value="1.4" data-i18n="opt_reinf3">Reinf ≥ D13 + Ties</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_en">Eccentric <span class="math-symbol">e'<sub>N</sub></span> [cm]</label>
                                    <input type="number" id="e_prime_n" value="0" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_ev">Eccentric <span class="math-symbol">e'<sub>V</sub></span> [cm]</label>
                                    <input type="number" id="e_prime_v" value="0" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Loads -->
                    <div class="px-6 pb-6">
                        <h4 class="text-xs font-bold text-eng-danger uppercase border-b pb-1 mb-2 text-red-600" data-i18n="sec_loads">Applied Factored Loads</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-50 p-3 rounded border border-red-100">
                                <label class="text-xs font-bold text-red-700" data-i18n="lbl_t">Tension (<span class="math-symbol">N<sub>ua</sub></span>) [kgf]</label>
                                <input type="number" id="loadT" value="15000" class="calc-input w-full border border-red-300 rounded p-1 mt-1 text-right text-red-800">
                            </div>
                            <div class="bg-red-50 p-3 rounded border border-red-100">
                                <label class="text-xs font-bold text-red-700" data-i18n="lbl_v">Shear (<span class="math-symbol">V<sub>ua</sub></span>) [kgf]</label>
                                <input type="number" id="loadV" value="5000" class="calc-input w-full border border-red-300 rounded p-1 mt-1 text-right text-red-800">
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 border-t border-gray-200">
                        <button onclick="performCalculation()" class="w-full bg-eng-primary hover:bg-blue-800 text-white font-bold py-3 px-6 rounded shadow-lg transform transition active:scale-[0.99] flex justify-center items-center">
                            <i class="fa-solid fa-gears mr-2"></i> <span data-i18n="btn_run">Run Structural Analysis (Ch. 17)</span>
                        </button>
                    </div>
                </div>

                <!-- RESULTS CONTAINER (Interactive View) -->
                <div id="results-container" class="hidden space-y-6">
                    <div class="flex space-x-2">
                        <button onclick="saveResult()" id="save-btn" class="flex-1 bg-green-600 text-white py-2 rounded shadow hover:bg-green-700 transition font-bold text-sm">
                            <i class="fa-solid fa-cloud-arrow-up mr-2"></i><span data-i18n="btn_save">Save to Cloud</span>
                        </button>
                        <button onclick="printReport()" class="flex-1 bg-gray-700 text-white py-2 rounded shadow hover:bg-gray-800 transition font-bold text-sm">
                            <i class="fa-solid fa-print mr-2"></i><span data-i18n="btn_pdf">Download Report</span>
                        </button>
                    </div>

                    <!-- 1. TENSION SUMMARY -->
                    <div id="card-tension" class="bg-white rounded border-l-4 border-l-eng-primary shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700">Tension Analysis (<span class="math-symbol">N<sub>ua</sub></span> vs <span class="math-symbol">ϕN<sub>n</sub></span>)</h4>
                            <span id="tension-governing" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold"></span>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Steel Tension -->
                            <div class="grid grid-cols-2 gap-4 border-b pb-2">
                                <div><span class="text-gray-500 text-xs block">Steel Strength (<span class="math-symbol">ϕN<sub>sa</sub></span>)</span><span id="res-phiNsa" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block">Pullout Strength (<span class="math-symbol">ϕN<sub>pn</sub></span>)</span><span id="res-phiNpn" class="font-mono font-bold"></span></div>
                            </div>
                            
                            <!-- New Modes (Bond & Side-Face) -->
                            <div id="row-bond" class="hidden grid grid-cols-2 gap-4 border-b pb-2">
                                <div><span class="text-gray-500 text-xs block">Bond Strength (<span class="math-symbol">ϕN<sub>a</sub></span>)</span><span id="res-phiNa" class="font-mono font-bold"></span></div>
                                <div class="text-xs text-gray-400 italic mt-1">Adhesive Anchors Only</div>
                            </div>
                            <div id="row-blowout" class="hidden grid grid-cols-2 gap-4 border-b pb-2">
                                <div><span class="text-gray-500 text-xs block">Side-Face Blowout (<span class="math-symbol">ϕN<sub>sb</sub></span>)</span><span id="res-phiNsb" class="font-mono font-bold"></span></div>
                                <div class="text-xs text-gray-400 italic mt-1">Deep Embedment Only</div>
                            </div>

                            <!-- Concrete Breakout -->
                            <div>
                                <h5 class="font-bold text-gray-600 text-xs mb-1 uppercase">Concrete Breakout (<span class="math-symbol">ϕN<sub>cbg</sub></span>)</h5>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div><span class="text-gray-400 block">Nb</span><span id="res-Nb" class="font-mono"></span></div>
                                    <div><span class="text-gray-400 block">ANc/ANco</span><span id="res-AncRatio" class="font-mono"></span></div>
                                    <div><span class="text-gray-400 block">Strength</span><span id="res-phiNcbg" class="font-bold text-eng-primary"></span></div>
                                </div>
                            </div>

                            <!-- Final Tension Check -->
                            <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                <div>
                                    <span class="text-gray-500 text-xs block">Gov. Tension Ratio</span>
                                    <span id="res-tensionRatio" class="font-bold text-lg"></span>
                                </div>
                                <span id="badge-tension" class="text-xs px-2 py-1 rounded font-bold"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 2. SHEAR SUMMARY -->
                    <div id="card-shear" class="bg-white rounded border-l-4 border-l-eng-primary shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700">Shear Analysis (<span class="math-symbol">V<sub>ua</sub></span> vs <span class="math-symbol">ϕV<sub>n</sub></span>)</h4>
                            <span id="shear-governing" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold"></span>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Steel Shear -->
                            <div class="grid grid-cols-2 gap-4 border-b pb-2">
                                <div><span class="text-gray-500 text-xs block">Steel Strength (<span class="math-symbol">ϕV<sub>sa</sub></span>)</span><span id="res-phiVsa" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block">Pryout Strength (<span class="math-symbol">ϕV<sub>cp</sub></span>)</span><span id="res-phiVcp" class="font-mono font-bold"></span></div>
                            </div>

                            <!-- Concrete Breakout -->
                            <div>
                                <h5 class="font-bold text-gray-600 text-xs mb-1 uppercase">Concrete Breakout (<span class="math-symbol">ϕV<sub>cbg</sub></span>)</h5>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div><span class="text-gray-400 block">Vb</span><span id="res-Vb" class="font-mono"></span></div>
                                    <div><span class="text-gray-400 block">AVc/AVco</span><span id="res-AvcRatio" class="font-mono"></span></div>
                                    <div><span class="text-gray-400 block">Strength</span><span id="res-phiVcbg" class="font-bold text-eng-primary"></span></div>
                                </div>
                            </div>

                            <!-- Final Shear Check -->
                            <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                <div>
                                    <span class="text-gray-500 text-xs block">Gov. Shear Ratio</span>
                                    <span id="res-shearRatio" class="font-bold text-lg"></span>
                                </div>
                                <span id="badge-shear" class="text-xs px-2 py-1 rounded font-bold"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 3. INTERACTION SUMMARY -->
                    <div id="card-interaction" class="bg-white rounded border-l-4 border-l-eng-warning shadow">
                        <div class="p-3 bg-gray-50 border-b">
                            <h4 class="font-bold text-sm text-gray-700">Interaction Check (Sec. 17.8)</h4>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div class="text-sm">
                                <span class="math-symbol">N<sub>ua</sub>/ϕN<sub>n</sub> + V<sub>ua</sub>/ϕV<sub>n</sub> ≤ 1.2</span>
                            </div>
                            <div class="text-right">
                                <div id="res-interactionVal" class="font-bold text-xl text-eng-warning"></div>
                                <span id="badge-interaction" class="text-xs px-2 py-0.5 rounded font-bold"></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB: HISTORY -->
            <div id="view-history" class="hidden">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700" data-i18n="history_title">Database Records</h3>
                        <div class="flex space-x-3">
                            <button onclick="clearHistory()" class="text-red-500 text-sm hover:underline font-bold"><i class="fa-solid fa-trash mr-1"></i><span data-i18n="btn_clear">Clear All</span></button>
                            <button onclick="loadHistory()" class="text-eng-primary text-sm hover:underline"><i class="fa-solid fa-rotate mr-1"></i><span data-i18n="btn_refresh">Refresh</span></button>
                        </div>
                    </div>
                    <div id="history-list" class="divide-y divide-gray-200 max-h-[70vh] overflow-y-auto">
                        <div class="p-10 text-center text-gray-400 flex flex-col items-center">
                            <i class="fa-solid fa-server text-4xl mb-3 opacity-30"></i>
                            <p data-i18n="msg_auth_req">Authentication required to view records.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

    </div>

    <!-- PRINT STAGING AREA -->
    <div id="print-staging"></div>

    <!-- Logic Script -->
    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAP0nsg3Saf_W0lEk5Mdt4oVKhFQJ69BOg",
            authDomain: "anchor-app-a1426.firebaseapp.com",
            projectId: "anchor-app-a1426",
            storageBucket: "anchor-app-a1426.firebasestorage.app",
            messagingSenderId: "822722897072",
            appId: "1:822722897072:web:32f8dabc44735718af0775",
            measurementId: "G-5GVPXDBJM1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentData = null;
        let historyCache = {};
        let currentLang = 'en';

        // --- TRANSLATION DATA (Simplified for brevity) ---
        const translations = {
            en: { app_title: "Anchor Analysis", btn_run: "Run Structural Analysis (Ch. 17)", btn_save: "Save to Cloud", btn_pdf: "Download Report" },
            zh: { app_title: "錨栓設計分析", btn_run: "執行結構分析 (Ch. 17)", btn_save: "儲存至雲端", btn_pdf: "下載報告" }
        };

        function t(key) { return translations[currentLang][key] || key; }
        function toggleLanguage() { currentLang = currentLang === 'en' ? 'zh' : 'en'; document.getElementById('lang-label').innerText = currentLang === 'en' ? '中文' : 'EN'; }

        // --- UI TOGGLES ---
        window.toggleTypeInputs = function() {
            const type = document.getElementById('anchor_type_detailed').value;
            document.getElementById('input-hooked').classList.toggle('hidden', type !== 'cast_hooked');
            document.getElementById('input-adhesive').classList.toggle('hidden', type !== 'post_adhesive');
        };

        // --- AUTH LOGIC (Standard) ---
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-email').innerText = user.email || `Guest: ${user.uid.substring(0, 6)}`;
                if (!document.getElementById('view-history').classList.contains('hidden')) loadHistory();
            } else {
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
            }
        });
        document.getElementById('login-btn').addEventListener('click', () => document.getElementById('auth-modal').classList.remove('hidden'));
        document.getElementById('guest-login').addEventListener('click', async () => { await auth.signInAnonymously(); });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); window.location.reload(); });


        // ==========================================
        //  CORE CALCULATION ENGINE (Chapter 17)
        // ==========================================
        window.performCalculation = function () {
            // 1. Gather Inputs
            const val = (id) => parseFloat(document.getElementById(id).value) || 0;
            const str = (id) => document.getElementById(id).value;
            const isChecked = (id) => document.getElementById(id).checked;

            const I = {
                fc: val('fc'), ha: val('ha'), da: val('da'), hef: val('hef'),
                futa: val('futa'), ase: val('ase'), abrg: val('abrg'),
                s1: val('s1'), s2: val('s2'),
                ca1: val('ca1'), ca1_1: val('ca1_1'), ca2: val('ca2'),
                T: val('loadT'), V: val('loadV'),
                type_detail: str('anchor_type_detailed'), // cast_headed, cast_hooked, post_expansion, post_screw, post_adhesive
                eh: val('eh'), // Hook extension
                tau: val('tau'), tau_uncr: val('tau_uncr'), // Bond stress
                lambda: parseFloat(str('lambda_select')), 
                reinf_factor_V: parseFloat(str('psi_c_V_select')),
                e_prime_n: val('e_prime_n'), e_prime_v: val('e_prime_v'),
                is_cracked: isChecked('is_cracked'),
                is_seismic: isChecked('is_seismic')
            };

            // 2. Set Derived Parameters based on Type
            let kc = 10;
            if (I.type_detail.startsWith('post')) kc = 7;
            
            // Phi Factors
            const PHI = {
                tension_steel: 0.75,
                tension_conc: I.reinf_factor_V > 1.0 ? 0.75 : 0.70,
                tension_pullout: 0.70,
                tension_bond: 0.65, // Standard adhesive (uncracked/cracked varies, simplified here)
                shear_steel: 0.65,
                shear_conc: I.reinf_factor_V > 1.0 ? 0.75 : 0.70,
                shear_pryout: 0.70
            };
            // Post-installed usually has lower phi for pullout/bond categories (Cat 1, 2, 3). 
            // Simplified: Cat 1 assumed.

            const seismicFactor = I.is_seismic ? 0.75 : 1.0;

            // --- TENSION CALCULATIONS ---

            // A. Steel Strength
            const Nsa = I.ase * I.futa * 4; 
            const phiNsa = PHI.tension_steel * Nsa;

            // B. Concrete Breakout
            const Nb = kc * I.lambda * Math.sqrt(I.fc) * Math.pow(I.hef, 1.5);
            const Anco = 9 * Math.pow(I.hef, 2);
            const ca1_eff = Math.min(I.ca1, 1.5 * I.hef);
            const ca2_eff = Math.min(I.ca2, 1.5 * I.hef);
            const Anc = (ca2_eff + I.s2 + 1.5 * I.hef) * (ca1_eff + I.s1 + 1.5 * I.hef);
            
            const c_min = Math.min(I.ca1, I.ca1_1, I.ca2);
            let psi_ed_N = (c_min < 1.5 * I.hef) ? (0.7 + 0.3 * (c_min / (1.5 * I.hef))) : 1.0;
            let psi_c_N = I.is_cracked ? 1.0 : 1.25; 
            if (I.type_detail.startsWith('post') && !I.is_cracked) psi_c_N = 1.4; // Post-installed uncracked
            
            let psi_ec_N = 1.0; if (I.e_prime_n > 0) psi_ec_N = 1.0 / (1.0 + (2.0 * I.e_prime_n) / (3.0 * I.hef));

            const Ncbg = (Anc / Anco) * psi_ed_N * psi_c_N * 1.0 * psi_ec_N * Nb;
            const phiNcbg = PHI.tension_conc * seismicFactor * Ncbg;

            // C. Pullout Strength
            let Npn_nominal = 0;
            let usePullout = true;
            if (I.type_detail === 'cast_headed') {
                Npn_nominal = 8 * I.abrg * I.fc;
            } else if (I.type_detail === 'cast_hooked') {
                // Np = 0.9 * fc * eh * da
                Npn_nominal = 0.9 * I.fc * I.eh * I.da;
            } else {
                // Post-installed mechanical usually requires product data. 
                // We will assume breakout governs or user needs to verify, but for adhesive/bond we calc bond separately.
                // For Expansion/Screw, we treat Pullout as N/A in this generic tool unless user inputs a value.
                // However, to avoid "0" strength, we'll set it high to let breakout govern, or check logic.
                usePullout = false; 
            }
            
            const psi_c_P = I.is_cracked ? 1.0 : 1.4;
            const Npn_group = Npn_nominal * psi_c_P * 4; 
            const phiNpn = usePullout ? (PHI.tension_pullout * seismicFactor * Npn_group) : 999999;

            // D. Bond Strength (Adhesive Only)
            let phiNa = 999999;
            if (I.type_detail === 'post_adhesive') {
                const tau = I.is_cracked ? I.tau : I.tau_uncr;
                const Nba = I.lambda * tau * Math.PI * I.da * I.hef;
                // Simplified group factor (approx same as breakout area ratio logic but with cNa)
                // cNa = 10da * sqrt(tau_uncr/77) approx... simplified to hef logic for this tool
                // We'll use the Breakout Geometry for Bond group effect approximation 
                const Nag = (Anc / Anco) * psi_ed_N * psi_ec_N * Nba; // Approximation
                phiNa = PHI.tension_bond * seismicFactor * Nag;
            }

            // E. Side-Face Blowout (Deep Headed Only)
            let phiNsb = 999999;
            if (I.type_detail === 'cast_headed' && I.hef > 2.5 * I.ca1) {
                const Nsb_single = 13 * I.ca1 * Math.sqrt(I.abrg) * Math.sqrt(I.fc); // SI Units roughly
                // Group factor
                const Nsb_group = Nsb_single * (1 + I.s2/(6*I.ca1)) * 2; // Rough 2 rows
                phiNsb = PHI.tension_conc * seismicFactor * Nsb_group;
            }

            // GOVERNING TENSION
            let phiNn = Math.min(phiNsa, phiNcbg, phiNpn, phiNa, phiNsb);
            const tensionRatio = I.T > 0 ? (I.T / phiNn) : 0;
            
            // Determine Mode Name
            let tMode = "Concrete Breakout";
            if (phiNn === phiNsa) tMode = "Steel Strength";
            else if (phiNn === phiNpn) tMode = "Pullout Strength";
            else if (phiNn === phiNa) tMode = "Bond Strength";
            else if (phiNn === phiNsb) tMode = "Side-Face Blowout";


            // --- SHEAR CALCULATIONS (Standard) ---
            const Vsa = 4 * 0.6 * I.ase * I.futa; 
            const phiVsa = PHI.shear_steel * Vsa;

            const Vb = 3.8 * I.lambda * Math.sqrt(I.fc) * Math.pow(I.ca1_1, 1.5); // Simplified Vb
            const Avco = 4.5 * Math.pow(I.ca1_1, 2);
            const Avc = ((1.5 * I.ca1_1) + I.s2 + (1.5 * I.ca1_1)) * I.ha;
            let psi_ed_V = (I.ca2 < 1.5 * I.ca1_1) ? (0.7 + 0.3 * (I.ca2 / (1.5 * I.ca1_1))) : 1.0;
            let psi_h_V = Math.sqrt((1.5 * I.ca1_1) / I.ha); if (psi_h_V < 1.0) psi_h_V = 1.0;

            const Vcbg = (Avc / Avco) * psi_ed_V * I.reinf_factor_V * psi_h_V * Vb;
            const phiVcbg = PHI.shear_conc * seismicFactor * Vcbg;

            // Pryout
            const kcp = I.hef < 6.5 ? 1.0 : 2.0;
            // Pryout uses the governing Tension Breakout/Bond strength as base
            const Ncp_base = Math.min(Ncbg, (I.type_detail === 'post_adhesive' ? (phiNa/PHI.tension_bond) : 999999));
            const Vcp = kcp * Ncp_base;
            const phiVcp = PHI.shear_pryout * seismicFactor * Vcp;

            // GOVERNING SHEAR
            let phiVn = Math.min(phiVsa, phiVcbg, phiVcp);
            const shearRatio = I.V > 0 ? (I.V / phiVn) : 0;
            let sMode = "Concrete Breakout";
            if (phiVn === phiVsa) sMode = "Steel Strength";
            else if (phiVn === phiVcp) sMode = "Pryout Strength";


            // --- INTERACTION ---
            const interactionCheck = (tensionRatio + shearRatio);

            currentData = {
                inputs: I,
                results: {
                    tension: {
                        phiNsa, phiNcbg, phiNpn, phiNa, phiNsb, 
                        Nb, Anc, Anco, 
                        governing: tMode, ratio: tensionRatio, capacity: phiNn
                    },
                    shear: {
                        phiVsa, phiVcbg, phiVcp, Vb, Avc, Avco,
                        governing: sMode, ratio: shearRatio, capacity: phiVn
                    },
                    interaction: { val: interactionCheck, ok: interactionCheck <= 1.2 }
                },
                factors: { psi_ed_N, psi_ed_V, psi_ec_N: psi_ec_N, psi_ec_V: 1.0 },
                timestamp: new Date()
            };
            updateUI();
        };

        function updateUI() {
            if (!currentData) return;
            const res = currentData.results;
            const t = res.tension;
            const s = res.shear;
            const I = currentData.inputs;
            
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('row-bond').classList.toggle('hidden', I.type_detail !== 'post_adhesive');
            document.getElementById('row-blowout').classList.toggle('hidden', !(I.type_detail === 'cast_headed' && I.hef > 2.5 * I.ca1));

            const set = (id, val, unit = '') => {
                const el = document.getElementById(id);
                if(el) el.innerText = (val > 900000 ? 'N/A' : Math.round(val)) + unit;
            };
            const setFixed = (id, val) => document.getElementById(id).innerText = val.toFixed(2);
            
            // Tension
            set('res-phiNsa', t.phiNsa, ' kgf');
            set('res-phiNpn', t.phiNpn, ' kgf');
            set('res-phiNa', t.phiNa, ' kgf');
            set('res-phiNsb', t.phiNsb, ' kgf');
            set('res-Nb', t.Nb, ' kgf');
            setFixed('res-AncRatio', t.Anc / t.Anco);
            set('res-phiNcbg', t.phiNcbg, ' kgf');
            document.getElementById('tension-governing').innerText = t.governing;
            setFixed('res-tensionRatio', t.ratio);
            setStatus('badge-tension', t.ratio <= 1.0);

            // Shear
            set('res-phiVsa', s.phiVsa, ' kgf');
            set('res-phiVcp', s.phiVcp, ' kgf');
            set('res-Vb', s.Vb, ' kgf');
            setFixed('res-AvcRatio', s.Avc / s.Avco);
            set('res-phiVcbg', s.phiVcbg, ' kgf');
            document.getElementById('shear-governing').innerText = s.governing;
            setFixed('res-shearRatio', s.ratio);
            setStatus('badge-shear', s.ratio <= 1.0);

            // Interaction
            setFixed('res-interactionVal', res.interaction.val);
            setStatus('badge-interaction', res.interaction.ok);

            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }

        function setStatus(id, isOk) {
            const el = document.getElementById(id);
            if (isOk) { el.innerText = "PASS"; el.className = "text-xs px-2 py-0.5 rounded font-bold bg-green-100 text-green-800 border border-green-200"; }
            else { el.innerText = "FAIL"; el.className = "text-xs px-2 py-0.5 rounded font-bold bg-red-100 text-red-800 border border-red-200"; }
        }

        // Print & Save functions remain similar but updated to reflect new data
        window.printReport = function () {
            if (!currentData) { alert("Please run the analysis first."); return; }
            const d = currentData; const res = d.results;
            const dateStr = new Date().toLocaleDateString();
            const staging = document.getElementById('print-staging');

            let html = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 20px;">
                        <div>
                            <h1 style="color: #004a99; font-size: 20pt; margin: 0; font-weight:bold;">Anchor Analysis</h1>
                            <p style="font-size: 10pt; color: #555; margin: 2px 0 0 0;">ACI 318-19 Chapter 17 Compliance</p>
                        </div>
                        <div style="text-align: right; font-size: 9pt; color: #777;">${dateStr}</div>
                    </div>

                    <h2>Design Inputs</h2>
                    <table>
                        <tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
                        <tr><td>Type</td><td>${d.inputs.type_detail}</td><td>-</td></tr>
                        <tr><td>f'c</td><td>${d.inputs.fc}</td><td>kgf/cm²</td></tr>
                        <tr><td>hef</td><td>${d.inputs.hef}</td><td>cm</td></tr>
                        <tr><td>Steel futa</td><td>${d.inputs.futa}</td><td>kgf/cm²</td></tr>
                        <tr><td>Load T</td><td>${d.inputs.T}</td><td>kgf</td></tr>
                        <tr><td>Seismic</td><td>${d.inputs.is_seismic ? 'Yes' : 'No'}</td><td>-</td></tr>
                    </table>

                    <h2>Results Summary</h2>
                    
                    <h3>Tension Analysis (Gov: ${res.tension.governing})</h3>
                    <table>
                        <tr><th>Mode</th><th>Strength (kgf)</th></tr>
                        <tr><td>Steel Strength</td><td>${Math.round(res.tension.phiNsa)}</td></tr>
                        <tr><td>Pullout</td><td>${res.tension.phiNpn > 900000 ? 'N/A' : Math.round(res.tension.phiNpn)}</td></tr>
                        <tr><td>Bond</td><td>${res.tension.phiNa > 900000 ? 'N/A' : Math.round(res.tension.phiNa)}</td></tr>
                        <tr><td>Breakout</td><td>${Math.round(res.tension.phiNcbg)}</td></tr>
                        <tr style="background:#e6f3ff; font-weight:bold"><td>Demand/Capacity</td><td>${res.tension.ratio.toFixed(2)}</td></tr>
                    </table>

                    <h3>Shear Analysis (Gov: ${res.shear.governing})</h3>
                    <table>
                        <tr><th>Mode</th><th>Strength (kgf)</th></tr>
                        <tr><td>Steel Strength</td><td>${Math.round(res.shear.phiVsa)}</td></tr>
                        <tr><td>Pryout</td><td>${Math.round(res.shear.phiVcp)}</td></tr>
                        <tr><td>Breakout</td><td>${Math.round(res.shear.phiVcbg)}</td></tr>
                        <tr style="background:#e6f3ff; font-weight:bold"><td>Demand/Capacity</td><td>${res.shear.ratio.toFixed(2)}</td></tr>
                    </table>

                    <h3>Interaction Check</h3>
                    <p><strong>Value: ${res.interaction.val.toFixed(2)}</strong> (Limit 1.2) - ${res.interaction.ok ? 'PASS' : 'FAIL'}</p>
                    <div class="report-footer">Report generated on ${dateStr}</div>`;

            staging.innerHTML = html;
            window.print();
        };
        
        window.saveResult = async function () {
            if (!currentUser) { alert("Please login first."); return; }
            const btn = document.getElementById('save-btn'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>' + (currentLang === 'en' ? 'Saving...' : '儲存中...');
            performCalculation(); if (!currentData) return;
            try {
                await db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').add({
                    inputs: currentData.inputs, summary: { ratio1: currentData.calcs.c1.ratio, ratio2: currentData.calcs.c2.ratio, ratio3: currentData.calcs.c3.ratio, ratio4: currentData.calcs.c4.ratio, allPass: currentData.calcs.c1.ok && currentData.calcs.c2.ok && currentData.calcs.c3.ok && currentData.calcs.c4.ok },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saved!'; setTimeout(() => btn.innerHTML = `<i class="fa-solid fa-cloud-arrow-up mr-2"></i>${t('btn_save')}`, 2000);
            } catch (e) { console.error(e); btn.innerHTML = 'Error'; }
        };

        window.clearHistory = async function () {
            if (!currentUser) return; if (!confirm("Are you sure?")) return;
            const list = document.getElementById('history-list'); list.innerHTML = '<div class="p-6 text-center text-red-500"><i class="fa-solid fa-trash fa-bounce mr-2"></i>Deleting...</div>';
            try {
                const snapshot = await db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').get();
                const batch = db.batch(); snapshot.docs.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); loadHistory();
            } catch (e) { console.error(e); alert("Error deleting history."); }
        };

        window.restoreFromHistory = function (docId) {
            const data = historyCache[docId]; if (!data || !data.inputs) return;
            const setVal = (id, v) => document.getElementById(id).value = v; const I = data.inputs;
            setVal('fc', I.fc); setVal('ha', I.ha); setVal('da', I.da); setVal('hef', I.hef); setVal('s1', I.s1); setVal('s2', I.s2);
            setVal('ca1', I.ca1); setVal('ca1_1', I.ca1_1); setVal('ca2', I.ca2); setVal('loadT', I.T); setVal('loadV', I.V);
            setVal('kc_select', I.kc || 10); setVal('lambda_select', I.lambda % 1 === 0 ? I.lambda.toFixed(1) : I.lambda);
            setVal('le_select', I.le_mode || 'default'); setVal('psi_c_V_select', I.psi_c_V % 1 === 0 ? I.psi_c_V.toFixed(1) : I.psi_c_V);
            setVal('e_prime_n', I.e_prime_n || 0); setVal('e_prime_v', I.e_prime_v || 0);
            switchTab('calculator'); performCalculation();
        };

        window.loadHistory = function () {
            if (!currentUser) return; const list = document.getElementById('history-list');
            list.innerHTML = '<div class="p-6 text-center text-gray-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Loading...</div>';
            db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').limit(50).onSnapshot(snap => {
                if (snap.empty) { list.innerHTML = `<div class="p-8 text-center text-gray-400">${t('msg_no_rec')}</div>`; return; }
                let docs = []; historyCache = {};
                snap.forEach(doc => { const data = doc.data(); docs.push({ id: doc.id, ...data }); historyCache[doc.id] = data; });
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                let html = '';
                docs.forEach(d => {
                    const status = d.summary.allPass ? `<span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded">${t('pass')}</span>` : `<span class="text-red-600 font-bold text-xs bg-red-50 px-2 py-1 rounded">${t('fail')}</span>`;
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    html += `<div onclick="restoreFromHistory('${d.id}')" class="p-4 hover:bg-blue-50 flex justify-between items-center border-b cursor-pointer transition active:bg-blue-100">
                                <div><div class="flex items-center gap-2 mb-1">${status}<span class="text-xs font-mono text-gray-500">${date}</span></div>
                                <div class="text-sm font-semibold text-gray-700">T: ${d.inputs.T} | V: ${d.inputs.V}</div>
                                <div class="text-xs text-gray-400 mt-1 flex flex-wrap gap-1"><span class="bg-gray-100 px-1 rounded border">hef: ${d.inputs.hef}</span><span class="bg-gray-100 px-1 rounded border">da: ${d.inputs.da}</span></div></div>
                                <div class="text-eng-primary text-xs font-bold flex items-center">${t('open')} <i class="fa-solid fa-chevron-right ml-1"></i></div></div>`;
                });
                list.innerHTML = html;
            });
        };

        // ==========================================
        //  NEW PDF EXPORT (NATIVE PRINTING)
        // ==========================================
        window.printReport = function () {
            if (!currentData) { alert("Please run the analysis first."); return; }

            const d = currentData;
            const f = currentData.factors;
            const dateStr = new Date().toLocaleDateString();
            const staging = document.getElementById('print-staging');
            const txt = (key) => translations[currentLang][key] || key;

            const showT = d.inputs.T > 0;
            const showV = d.inputs.V > 0;

            // Define rich equation strings for Table
            const e_Nb = `<span class="math-symbol">N<sub>b</sub> = k<sub>c</sub>λ<sub>a</sub>√f'<sub>c</sub>h<sub>ef</sub><sup>1.5</sup></span>`;
            const e_Anc = `<span class="math-symbol">A<sub>Nc</sub> = 2(1.5h<sub>ef</sub>)(C<sub>a1</sub>+S<sub>1</sub>+1.5h<sub>ef</sub>)</span>`;
            const e_psiN = `<span class="math-symbol">ψ<sub>ed,N</sub> = 0.7+0.3(c<sub>a,min</sub>/1.5h<sub>ef</sub>)</span>`;
            const e_phiN = `<span class="math-symbol">ϕN<sub>cb</sub> = 0.75(A<sub>Nc</sub>/A<sub>Nco</sub>)ψ<sub>ed,N</sub>ψ<sub>c,N</sub>ψ<sub>cp,N</sub>N<sub>b</sub></span>`;

            const e_Ancg = `<span class="math-symbol">A<sub>Nc(g)</sub> = (C<sub>a2</sub>+S<sub>2</sub>+1.5h<sub>ef</sub>)(C<sub>a1</sub>+S<sub>1</sub>+1.5h<sub>ef</sub>)</span>`;
            const e_pecN = `<span class="math-symbol">ψ<sub>ec,N</sub> = 1/(1+2e'<sub>N</sub>/3h<sub>ef</sub>)</span>`;
            const e_phiNg = `<span class="math-symbol">ϕN<sub>cbg</sub> = 0.75(A<sub>Nc(g)</sub>/A<sub>Nco</sub>)ψ<sub>ec,N</sub>ψ<sub>ed,N</sub>ψ<sub>c,N</sub>...N<sub>b</sub></span>`;

            const e_Vb = `<span class="math-symbol">V<sub>b</sub> = min(V<sub>b1</sub>, V<sub>b2</sub>)</span>`;
            const e_Avc = `<span class="math-symbol">A<sub>Vc</sub> = 2(1.5C<sub>a1</sub>)h<sub>a</sub></span>`;
            const e_psiV = `<span class="math-symbol">ψ<sub>ed,V</sub> = 0.7+0.3(C<sub>a2</sub>/1.5C<sub>a1</sub>)</span>`;
            const e_phiV = `<span class="math-symbol">ϕV<sub>cb</sub> = 0.75(A<sub>Vc</sub>/A<sub>Vco</sub>)ψ<sub>ed,V</sub>ψ<sub>c,V</sub>ψ<sub>h,V</sub>V<sub>b</sub></span>`;

            const e_Avcg = `<span class="math-symbol">A<sub>Vc(g)</sub> = [(3C<sub>a1</sub>)+S<sub>2</sub>]h<sub>a</sub></span>`;
            const e_pecV = `<span class="math-symbol">ψ<sub>ec,V</sub> = 1/(1+2e'<sub>V</sub>/3C<sub>a1</sub>)</span>`;
            const e_phiVg = `<span class="math-symbol">ϕV<sub>cbg</sub> = 0.75(A<sub>Vc(g)</sub>/A<sub>Vco</sub>)ψ<sub>ec,V</sub>ψ<sub>ed,V</sub>ψ<sub>c,V</sub>...V<sub>b</sub></span>`;


            let html = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 20px;">
                        <div>
                            <h1 style="color: #004a99; font-size: 20pt; margin: 0; font-weight:bold;">Anchor Analysis</h1>
                            <p style="font-size: 10pt; color: #555; margin: 2px 0 0 0;">ACI/Structural Compliance Tool</p>
                        </div>
                        <div style="text-align: right; font-size: 9pt; color: #777;">
                            ${dateStr}
                        </div>
                    </div>

                    <h2>${txt('sec_mat')}</h2>
                    <table>
                        <tr><th>${txt('Parameter') || 'Parameter'}</th><th>${txt('Value') || 'Value'}</th><th>${txt('Unit') || 'Unit'}</th></tr>
                        <tr><td>${txt('lbl_fc')}</td><td>${d.inputs.fc}</td><td>kgf/cm²</td></tr>
                        <tr><td>${txt('lbl_ha')}</td><td>${d.inputs.ha}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_da')}</td><td>${d.inputs.da}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_hef')}</td><td>${d.inputs.hef}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_s1')}</td><td>${d.inputs.s1}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_s2')}</td><td>${d.inputs.s2}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_ca1')}</td><td>${d.inputs.ca1}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_ca1_1')}</td><td>${d.inputs.ca1_1}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_ca2')}</td><td>${d.inputs.ca2}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_t')}</td><td>${d.inputs.T}</td><td>kgf</td></tr>
                        <tr><td>${txt('lbl_v')}</td><td>${d.inputs.V}</td><td>kgf</td></tr>
                    </table>

                    <h2>${txt('sec_factors')}</h2>
                    <table>
                        <tr><th>Factor</th><th>Value</th><th>Note</th></tr>
                        <tr><td>${txt('lbl_kc')}</td><td>${d.inputs.kc}</td><td></td></tr>
                        <tr><td>${txt('lbl_lambda')}</td><td>${d.inputs.lambda}</td><td></td></tr>
                        <tr><td>${txt('lbl_le')}</td><td>${d.inputs.le_mode}</td><td></td></tr>
                        <tr><td>${txt('lbl_reinf')}</td><td>${d.inputs.psi_c_V}</td><td></td></tr>
                        <tr><td>${txt('lbl_en')}</td><td>${d.inputs.e_prime_n}</td><td>cm</td></tr>
                        <tr><td>${txt('lbl_ev')}</td><td>${d.inputs.e_prime_v}</td><td>cm</td></tr>
                    </table>

                    <div class="page-break">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
                            <div>
                                <h1 style="color: #666; font-size: 14pt; margin: 0; font-weight:bold;">Results</h1>
                            </div>
                            <div style="text-align: right; font-size: 9pt; color: #777;">
                                ${dateStr}
                            </div>
                        </div>
                    </div>`;

            if (showT) {
                html += `
                    <h3>${txt('res_t_title')}</h3>
                    <div style="margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Nb_pdf}</div>

                    <h4>${txt('res_t1_sub')}</h4>
                    <table>
                        <tr><th>Check Item</th><th>Equations</th><th>Value</th><th>Unit</th><th>Status</th></tr>
                        <tr><td>${txt('res_nb')}</td><td>${e_Nb}</td><td>${Math.round(d.calcs.c1.nb)}</td><td>kgf</td><td>-</td></tr>
                        <tr><td>${txt('res_anc')}</td><td>${e_Anc}</td><td>${Math.round(d.calcs.c1.anc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_edge')}</td><td>${e_psiN}</td><td>${f.psi_ed_N.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#e6f3ff">
                            <td><strong>${txt('res_cap')}</strong></td>
                            <td><strong>${e_phiN}</strong></td>
                            <td><strong>${Math.round(d.calcs.c1.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c1.ok ? 'pass' : 'fail'}">${d.calcs.c1.ok ? 'OK' : 'FAIL'}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>Load / Capacity</strong></td>
                            <td><strong>${(d.calcs.c1.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>

                    <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Ncbg_pdf}</div>
                    <h4>${txt('res_tg_sub')}</h4>
                    <table>
                        <tr><th>Check Item</th><th>Equations</th><th>Value</th><th>Unit</th><th>Status</th></tr>
                        <tr><td>${txt('res_anc_g')}</td><td>${e_Ancg}</td><td>${Math.round(d.calcs.c3.anc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_ecc')}</td><td>${e_pecN}</td><td>${f.psi_ec_N.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#f9f9e0">
                            <td><strong>${txt('res_cap_g')}</strong></td>
                            <td><strong>${e_phiNg}</strong></td>
                            <td><strong>${Math.round(d.calcs.c3.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c3.ok ? 'pass' : 'fail'}">${d.calcs.c3.ok ? 'OK' : 'FAIL'}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>Load / Capacity</strong></td>
                            <td><strong>${(d.calcs.c3.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>`;
            }

            if (showV) {
                html += `
                    <h3>${txt('res_v_title')}</h3>
                    <div style="margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Vb_pdf}</div>

                    <h4>${txt('res_v1_sub')}</h4>
                    <table>
                        <tr><th>Check Item</th><th>Equations</th><th>Value</th><th>Unit</th><th>Status</th></tr>
                        <tr><td>${txt('res_vb')}</td><td>${e_Vb}</td><td>${Math.round(d.calcs.c2.vb)}</td><td>kgf</td><td>-</td></tr>
                        <tr><td>${txt('res_avc')}</td><td>${e_Avc}</td><td>${Math.round(d.calcs.c2.avc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_edge')}</td><td>${e_psiV}</td><td>${f.psi_ed_V.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#e6f3ff">
                            <td><strong>${txt('res_cap')}</strong></td>
                            <td><strong>${e_phiV}</strong></td>
                            <td><strong>${Math.round(d.calcs.c2.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c2.ok ? 'pass' : 'fail'}">${d.calcs.c2.ok ? 'OK' : 'FAIL'}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>Load / Capacity</strong></td>
                            <td><strong>${(d.calcs.c2.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>

                    <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Vcbg_pdf}</div>
                    <h4>${txt('res_vg_sub')}</h4>
                    <table>
                        <tr><th>Check Item</th><th>Equations</th><th>Value</th><th>Unit</th><th>Status</th></tr>
                        <tr><td>${txt('res_avc_g')}</td><td>${e_Avcg}</td><td>${Math.round(d.calcs.c4.avc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_ecc')}</td><td>${e_pecV}</td><td>${f.psi_ec_V.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#f9f9e0">
                            <td><strong>${txt('res_cap_g')}</strong></td>
                            <td><strong>${e_phiVg}</strong></td>
                            <td><strong>${Math.round(d.calcs.c4.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c4.ok ? 'pass' : 'fail'}">${d.calcs.c4.ok ? 'OK' : 'FAIL'}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>Load / Capacity</strong></td>
                            <td><strong>${(d.calcs.c4.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>`;
            }

            html += `<div class="report-footer">Report generated on ${dateStr}</div>`;

            staging.innerHTML = html;
            window.print();
        };

        window.switchTab = function (t) {
            const calc = document.getElementById('view-calculator'); const hist = document.getElementById('view-history');
            const tabC = document.getElementById('tab-calculator'); const tabH = document.getElementById('tab-history');
            if (t === 'calculator') {
                calc.classList.remove('hidden'); hist.classList.add('hidden');
                tabC.classList.add('text-eng-primary', 'border-b-4', 'border-eng-primary', 'font-bold'); tabC.classList.remove('text-gray-500', 'font-medium');
                tabH.classList.remove('text-eng-primary', 'border-b-4', 'border-eng-primary', 'font-bold'); tabH.classList.add('text-gray-500', 'font-medium');
            } else {
                calc.classList.add('hidden'); hist.classList.remove('hidden');
                tabH.classList.add('text-eng-primary', 'border-b-4', 'border-eng-primary', 'font-bold'); tabH.classList.remove('text-gray-500', 'font-medium');
                tabC.classList.remove('text-eng-primary', 'border-b-4', 'border-eng-primary', 'font-bold'); tabC.classList.add('text-gray-500', 'font-medium');
                loadHistory();
            }
        };
    </script>
</body>
</html>

