<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structural Anchor Analysis</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23004a99%22/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23004a99%22/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Three.js for 3D Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        eng: {
                            primary: '#004a99',
                            secondary: '#f0f2f5',
                            dark: '#1e293b',
                            success: '#10b981',
                            danger: '#ef4444',
                            warning: '#f59e0b'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .calc-input {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .math-symbol {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* PRINT SPECIFIC STYLES */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            /* Hide the web app UI */
            #root, #auth-modal, nav {
                display: none !important;
            }

            /* Show the print staging area */
            #print-staging {
                display: block !important;
                background: white;
                color: black;
                font-family: 'Arial', sans-serif;
                font-size: 11pt;
            }

            /* Force background colors to print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Page Break Logic */
            .page-break {
                break-before: page;
                page-break-before: always;
                margin-top: 2rem;
                display: block;
                clear: both;
            }

            table, tr, td, th {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            /* Report Styling */
            h1 {
                color: #004a99;
                font-size: 24pt;
                margin-bottom: 5px;
                font-weight: bold;
                border-bottom: 2px solid #004a99;
                padding-bottom: 10px;
            }

            h2 {
                color: #333;
                font-size: 14pt;
                margin-top: 20px;
                margin-bottom: 10px;
                background: #eee;
                padding: 5px 10px;
                font-weight: bold;
            }

            h3 {
                color: #004a99;
                font-size: 14pt;
                margin-top: 20px;
                margin-bottom: 10px;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
            }

            h4 {
                color: #555;
                font-size: 11pt;
                margin-top: 15px;
                margin-bottom: 5px;
                text-transform: uppercase;
                font-weight: bold;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
                font-size: 10pt;
            }

            th {
                background-color: #004a99;
                color: white;
                padding: 8px;
                text-align: left;
                font-weight: bold;
            }

            td {
                border: 1px solid #ddd;
                padding: 8px;
                vertical-align: middle;
            }

            tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            .pass {
                color: green;
                font-weight: bold;
            }

            .fail {
                color: red;
                font-weight: bold;
            }

            .report-footer {
                margin-top: 30px;
                border-top: 1px solid #ccc;
                padding-top: 5px;
                font-size: 8pt;
                color: #888;
                text-align: center;
                width: 100%;
            }
        }

        /* Hide print staging on normal screen */
        #print-staging {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans">

    <div id="root" class="min-h-screen flex flex-col">

        <!-- Navbar -->
        <nav class="bg-eng-primary text-white shadow-md sticky top-0 z-50">
            <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fa-solid fa-ruler-combined text-xl"></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight" data-i18n="app_title">Anchor Analysis</h1>
                        <p class="text-xs opacity-80 font-light" data-i18n="app_subtitle">ACI/Structural Compliance Tool</p>
                    </div>
                </div>
                <div id="auth-section" class="flex items-center gap-2">
                    <button onclick="toggleLanguage()" class="bg-blue-800 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold border border-blue-600 transition">
                        <i class="fa-solid fa-language mr-1"></i> <span id="lang-label">中文</span>
                    </button>
                    <button id="login-btn" class="bg-white text-eng-primary px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-gray-100 transition" data-i18n="btn_login">
                        <i class="fa-solid fa-user mr-2"></i>Login
                    </button>
                    <div id="user-info" class="hidden flex items-center space-x-4">
                        <span id="user-email" class="text-xs opacity-90 hidden sm:inline font-mono bg-blue-900 px-2 py-1 rounded"></span>
                        <button id="logout-btn" class="text-sm hover:text-gray-200"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow max-w-5xl mx-auto w-full p-4 space-y-6">

            <!-- Auth Modal -->
            <div id="auth-modal" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
                <div class="bg-white rounded-lg shadow-2xl p-8 w-11/12 max-w-sm border-t-4 border-eng-primary">
                    <h2 class="text-2xl font-bold mb-2 text-center text-eng-primary" data-i18n="modal_title">Access Portal</h2>
                    <p class="text-gray-500 mb-4 text-center text-sm" data-i18n="modal_desc">Sign in to sync your data across devices.</p>

                    <div class="space-y-3 mb-4">
                        <input type="email" id="auth-email" placeholder="Email" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-eng-primary outline-none">
                        <input type="password" id="auth-password" placeholder="Password" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-eng-primary outline-none">
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button id="email-login-btn" class="flex-1 bg-eng-primary text-white py-2 rounded text-sm font-bold hover:bg-blue-800 transition" data-i18n="btn_login_submit">Login</button>
                        <button id="email-register-btn" class="flex-1 bg-white text-eng-primary border border-eng-primary py-2 rounded text-sm font-bold hover:bg-blue-50 transition" data-i18n="btn_register">Register</button>
                    </div>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-xs">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <button id="guest-login" class="w-full bg-gray-200 text-gray-700 py-2 rounded mb-3 text-sm font-semibold hover:bg-gray-300 transition shadow-sm" data-i18n="btn_guest">
                        Continue as Guest
                    </button>
                    <p id="auth-error" class="text-xs text-red-500 text-center hidden mt-2"></p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-300 bg-white rounded-t-lg shadow-sm">
                <button onclick="switchTab('calculator')" id="tab-calculator" class="flex-1 py-4 text-center font-bold text-eng-primary border-b-4 border-eng-primary transition-colors">
                    <i class="fa-solid fa-calculator mr-2"></i><span data-i18n="tab_analysis">Analysis</span>
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-4 text-center font-medium text-gray-500 hover:text-eng-primary transition-colors">
                    <i class="fa-solid fa-server mr-2"></i><span data-i18n="tab_database">Database</span>
                </button>
            </div>

            <!-- TAB: CALCULATOR -->
            <div id="view-calculator" class="space-y-6 pb-20">

                <!-- INPUTS -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-gray-100 px-6 py-3 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700"><i class="fa-solid fa-pen-to-square mr-2"></i><span data-i18n="sec_params">Design Parameters</span></h3>
                        <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border">Units: kgf, cm</span>
                    </div>

                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                        <!-- 1. Geometry -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_mat">Material & Geometry</h4>
                            <!-- Advanced Layout Editor -->
                            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs font-bold text-gray-700" data-i18n="lbl_layout">Anchor Layout</label>
                                    <select id="layout_mode" class="w-40 text-xs border rounded px-2 py-1" onchange="toggleLayoutMode()">
                                        <option value="grid" data-i18n="opt_grid">Grid (S1/S2)</option>
                                        <option value="custom" data-i18n="opt_custom">Custom (X,Y)</option>
                                    </select>
                                </div>
                                <div id="div_grid_inputs" class="space-y-2">
                                    <!-- Keep original S1/S2 logic but move visibility -->
                                    <p class="text-[10px] text-gray-400" data-i18n="msg_spacing_note">Uses Vertical/Horizontal Spacing below.</p>
                                </div>
                                <div id="div_custom_coords" class="hidden space-y-3">
                                    <!-- Generator Tools -->
                                    <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                        <label class="text-[10px] font-bold text-gray-700 uppercase mb-1 block" data-i18n="lbl_gen_title">1. Grid Generator</label>
                                        <div class="grid grid-cols-3 gap-2 mb-2">
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_rows">Rows (Y)</label><input type="number" id="grid_rows" value="2" class="w-full text-xs border rounded p-1"></div>
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_cols">Cols (X)</label><input type="number" id="grid_cols" value="2" class="w-full text-xs border rounded p-1"></div>
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_action">Action</label><button onclick="generateGridAnchors()" class="w-full bg-blue-600 text-white text-[10px] py-1.5 rounded hover:bg-blue-700 font-bold" data-i18n="btn_add_grid">Add Grid</button></div>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_sp_x">Space X</label><input type="number" id="grid_sx" value="15" class="w-full text-xs border rounded p-1"></div>
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_sp_y">Space Y</label><input type="number" id="grid_sy" value="22" class="w-full text-xs border rounded p-1"></div>
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_st_x">Start X</label><input type="number" id="grid_st_x" value="0" class="w-full text-xs border rounded p-1"></div>
                                            <div><label class="text-[9px] text-gray-500" data-i18n="lbl_sp_y">Start Y</label><input type="number" id="grid_st_y" value="0" class="w-full text-xs border rounded p-1"></div>
                                        </div>
                                    </div>

                                    <!-- Anchor List Table -->
                                    <div>
                                        <div class="flex justify-between items-end mb-1">
                                            <label class="text-[10px] font-bold text-gray-700 uppercase" data-i18n="lbl_list_title">2. Anchor List</label>
                                            <button onclick="clearAllAnchors()" class="text-[9px] text-red-500 hover:underline" data-i18n="btn_clear_all">Clear All</button>
                                        </div>
                                        <div class="border rounded max-h-40 overflow-y-auto bg-white">
                                            <table class="w-full text-left border-collapse">
                                                <thead class="bg-gray-100 sticky top-0">
                                                    <tr>
                                                        <th class="text-[9px] p-1 border-b pl-2" data-i18n="tbl_head_num">#</th>
                                                        <th class="text-[9px] p-1 border-b" data-i18n="tbl_head_x">X (cm)</th>
                                                        <th class="text-[9px] p-1 border-b" data-i18n="tbl_head_y">Y (cm)</th>
                                                        <th class="text-[9px] p-1 border-b text-right pr-2" data-i18n="tbl_head_action">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="anchor_table_body" class="text-xs">
                                                    <!-- Dynamic Rows -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- Manual Add Single -->
                                        <div class="flex gap-2 mt-2 items-center">
                                            <input type="number" id="new_x" placeholder="X" class="w-16 text-xs border rounded p-1">
                                            <input type="number" id="new_y" placeholder="Y" class="w-16 text-xs border rounded p-1">
                                            <button onclick="addSingleAnchor()" class="flex-1 bg-gray-200 text-gray-700 text-[10px] py-1 rounded hover:bg-gray-300"><i class="fa-solid fa-plus mr-1"></i><span data-i18n="btn_add_pt">Add Point</span></button>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden Textarea for Logic Connection -->
                                    <textarea id="custom_coords" class="hidden"></textarea>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_fc">Concrete Strength (<span class="math-symbol">f'c</span>) [kgf/cm²]</label>
                                <input type="number" id="fc" value="280" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ha">Base Thickness (<span class="math-symbol">h<sub>a</sub></span>) [cm]</label>
                                <input type="number" id="ha" value="15" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <!-- NEW 1. Shear Lug Input -->
                            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                                <div class="flex items-center space-x-2 mb-1">
                                    <input type="checkbox" id="is_shearlug" onchange="toggleShearLug()" class="rounded border-gray-300 text-eng-primary shadow-sm">
                                    <label for="is_shearlug" class="text-xs font-bold text-gray-700" data-i18n="lbl_is_sl">Shear Lug (Sec 17.11)</label>
                                </div>
                                <!-- Inside the Shear Lug section -->
                                <div id="div_shearlug" class="hidden mt-1 space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-[10px] text-gray-500 block" data-i18n="lbl_sl_h">Height (cm)</label>
                                            <input type="number" id="sl_h" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-gray-500 block" data-i18n="lbl_sl_w">Width (cm)</label>
                                            <input type="number" id="sl_w" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-[10px] text-gray-500 block" data-i18n="lbl_sl_t">Thickness (cm)</label>
                                            <input type="number" id="sl_t" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-gray-500 block" data-i18n="lbl_sl_c">Edge Dist (cm)</label>
                                            <input type="number" id="sl_c" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Steel Properties Section -->
                            <div class="pt-2">
                                <h5 class="text-xs font-bold text-gray-400 mb-1" data-i18n="sec_steel_props">ANCHOR STEEL</h5>
                                <div class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-500" data-i18n="lbl_da">Diameter (<span class="math-symbol">d<sub>a</sub></span>) [cm]</label>
                                        <input type="number" id="da" value="1.6" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500" data-i18n="lbl_ase">Eff. Area (<span class="math-symbol">A<sub>se</sub></span>) [cm²]</label>
                                        <input type="number" id="ase" value="1.57" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-500" data-i18n="lbl_futa">Ult (<span class="math-symbol">f<sub>uta</sub></span>)</label>
                                            <input type="number" id="futa" value="4100" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500" data-i18n="lbl_fya">Yld (<span class="math-symbol">f<sub>ya</sub></span>)</label>
                                            <input type="number" id="fya" value="2800" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <!-- Step 4: Ductility -->
                                        <div>
                                            <label class="text-xs text-gray-500" data-i18n="lbl_ductility">Ductility</label>
                                            <select id="steel_ductility" class="w-full border border-gray-300 rounded p-1 text-xs" onchange="toggleSeismicDetailing()">
                                                <option value="ductile" data-i18n="opt_ductile">Ductile</option>
                                                <option value="brittle" data-i18n="opt_brittle">Brittle</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center space-x-1 mt-3">
                                            <input type="checkbox" id="is_grouted" class="rounded border-gray-300 text-eng-primary shadow-sm">
                                            <label for="is_grouted" class="text-xs text-gray-600" data-i18n="lbl_grouted">Grouted</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-2 border-t border-dashed space-y-2">
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_hef">Embedment (<span class="math-symbol">h<sub>ef</sub></span>) [cm]</label>
                                    <input type="number" id="hef" value="8.5" class="calc-input w-full border border-gray-300 rounded p-2 text-right" oninput="updateCac()">
                                </div>
                                <!-- Step 8: Critical Edge Distance -->
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_cac">Critical Edge Dist (<span class="math-symbol">c<sub>ac</sub></span>) [cm]</label>
                                    <input type="number" id="cac" value="21.25" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                                    <p class="text-[10px] text-gray-400 mt-0.5 text-right" data-i18n="msg_cac_default">Default: 2.5hef (Undercut) or 4hef (Exp)</p>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Spacing -->
                        <div id="spacing-inputs-section" class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_space">Spacing & Edge Dist</h4>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_s1">Vertical Spacing (<span class="math-symbol">S<sub>1</sub></span>) [cm]</label>
                                <input type="number" id="s1" value="22" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_s2">Horizontal Spacing (<span class="math-symbol">S<sub>2</sub></span>) [cm]</label>
                                <input type="number" id="s2" value="15" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca1">Top Edge (<span class="math-symbol">C<sub>a1</sub></span>) [cm]</label>
                                <input type="number" id="ca1" value="13" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca1_1">Bottom Edge (<span class="math-symbol">C<sub>a1,1</sub></span>) [cm]</label>
                                <input type="number" id="ca1_1" value="35" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_ca2">Side Edge (<span class="math-symbol">C<sub>a2</sub></span>) [cm]</label>
                                <input type="number" id="ca2" value="15" class="calc-input w-full border border-gray-300 rounded p-2 text-right">
                            </div>
                        </div>

                        <!-- 3. Coefficients -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-eng-primary uppercase border-b pb-1 mb-2" data-i18n="sec_factors">Factors & Coefficients</h4>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_kc">Anchor Type (<span class="math-symbol">k<sub>c</sub></span>)</label>
                                <select id="kc_select" class="w-full border border-gray-300 rounded p-2 text-xs" onchange="updateCac()">
                                    <option value="10" data-i18n="opt_cast">Cast-in Anchors (10)</option>
                                    <option value="7" data-i18n="opt_post">Post-installed (7)</option>
                                    <!-- NEW 6. Screw Anchor -->
                                    <option value="screw" data-i18n="opt_screw">Screw Anchor</option>
                                </select>
                            </div>

                            <!-- NEW Step 6: Seismic Design -->
                            <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="is_seismic" onchange="toggleSeismicDetailing()" class="rounded border-gray-300 text-eng-warning shadow-sm focus:ring-eng-warning">
                                    <label for="is_seismic" class="text-xs font-bold text-yellow-800" data-i18n="lbl_seismic">Seismic Design (0.75 Reduction)</label>
                                </div>
                                <!-- NEW 4. Seismic Stretch Length -->
                                <div id="div_stretch" class="hidden mt-2">
                                    <label class="text-xs text-gray-500" data-i18n="lbl_stretch">Stretch Length (<span class="math-symbol">L<sub>str</sub></span>) [cm]</label>
                                    <input type="number" id="stretch_len" placeholder=">= 8da" class="calc-input w-full border border-yellow-300 rounded p-1 text-right text-xs bg-white">
                                </div>
                            </div>

                            <!-- Condition A/B and Category -->
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_cond">Condition (Reinf)</label>
                                    <select id="condition_ab" class="w-full border border-gray-300 rounded p-2 text-xs">
                                        <option value="B" data-i18n="opt_cond_b">B (No Reinf)</option>
                                        <option value="A" data-i18n="opt_cond_a">A (Reinforced)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_cat">Category (Rel.)</label>
                                    <select id="anchor_category" class="w-full border border-gray-300 rounded p-2 text-xs">
                                        <option value="1" data-i18n="opt_cat1">1 (High Rel)</option>
                                        <option value="2" data-i18n="opt_cat2">2 (Med Rel)</option>
                                        <option value="3" data-i18n="opt_cat3">3 (Low Rel)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- NEW 2. Anchor Reinforcement -->
                            <div class="bg-gray-50 p-2 rounded border border-gray-200">
                                <div class="flex items-center space-x-2 mb-1">
                                    <input type="checkbox" id="is_reinf" onchange="toggleReinf()" class="rounded border-gray-300 text-eng-primary shadow-sm">
                                    <label for="is_reinf" class="text-xs font-bold text-gray-700" data-i18n="lbl_is_reinf">Anchor Reinf. Present?</label>
                                </div>
                                <div id="div_reinf" class="hidden mt-1 space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-[10px] text-gray-500" data-i18n="lbl_reinf_area">Area (cm²)</label>
                                            <input type="number" id="reinf_area" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-gray-500" data-i18n="lbl_reinf_yield">Yield (kgf/cm²)</label>
                                            <input type="number" id="reinf_fy" value="2800" class="calc-input w-full border border-gray-300 rounded p-1 text-right text-xs">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Adhesive Toggle -->
                            <div class="bg-blue-50 p-2 rounded border border-blue-100">
                                <div class="flex items-center space-x-2 mb-1">
                                    <input type="checkbox" id="is_adhesive" onchange="toggleAdhesive()" class="rounded border-gray-300 text-eng-primary shadow-sm focus:border-eng-primary focus:ring focus:ring-eng-primary focus:ring-opacity-50">
                                    <label for="is_adhesive" class="text-xs font-bold text-blue-800" data-i18n="lbl_is_adh">Adhesive Anchor</label>
                                </div>
                                <div id="div_adhesive" class="hidden mt-1">
                                    <label class="text-xs text-gray-500" data-i18n="lbl_tau">Bond Stress (<span class="math-symbol">τ</span>) [kgf/cm²]</label>
                                    <input type="number" id="tau" value="100" class="calc-input w-full border border-blue-300 rounded p-1 text-right text-xs bg-white">
                                </div>
                            </div>

                            <!-- Pullout Inputs (Step 2) -->
                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_pull_mode">Pullout Mode</label>
                                <select id="pullout_mode" class="w-full border border-gray-300 rounded p-2 text-xs" onchange="togglePulloutInputs()">
                                    <option value="headed" data-i18n="opt_headed">Headed Bolt/Stud</option>
                                    <option value="hooked" data-i18n="opt_hooked">Hooked Bolt (J/L)</option>
                                    <option value="post" data-i18n="opt_post_cert">Post-installed (Cert.)</option>
                                </select>
                            </div>

                            <div id="div_abrg">
                                <label class="text-xs text-gray-500" data-i18n="lbl_abrg">Bearing Area (<span class="math-symbol">A<sub>brg</sub></span>) [cm²]</label>
                                <input type="number" id="abrg" value="3.5" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                            </div>

                            <div id="div_eh" class="hidden">
                                <label class="text-xs text-gray-500" data-i18n="lbl_eh">Hook Length (<span class="math-symbol">e<sub>h</sub></span>) [cm]</label>
                                <input type="number" id="eh" value="5.0" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                            </div>

                            <div id="div_np" class="hidden">
                                <label class="text-xs text-gray-500" data-i18n="lbl_np_cert">Certified Pullout (<span class="math-symbol">N<sub>p</sub></span>) [kgf]</label>
                                <input type="number" id="np_certified" value="2000" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_crack_p">Pullout Cracking (<span class="math-symbol">ψ<sub>c,P</sub></span>)</label>
                                <select id="crack_cond_p" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="1.4" data-i18n="opt_uncracked">Uncracked (1.4)</option>
                                    <option value="1.0" data-i18n="opt_cracked">Cracked (1.0)</option>
                                </select>
                            </div>
                            <!-- End Step 2 Inputs -->

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_lambda">Failure Factor (<span class="math-symbol">λ<sub>a</sub></span>)</label>
                                <select id="lambda_select" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="1.0" data-i18n="opt_lam1">Cast-in/Undercut (1.0)</option>
                                    <option value="0.8" data-i18n="opt_lam2">Expansion/Bonded (0.8)</option>
                                    <option value="0.6" data-i18n="opt_lam3">Bonded Failure (0.6)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_le">Load Length (<span class="math-symbol">l<sub>e</sub></span>)</label>
                                <select id="le_select" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="default" data-i18n="opt_le1">Default/All (8da)</option>
                                    <option value="sleeve" data-i18n="opt_le2">Full Sleeve/Headed (hef)</option>
                                    <option value="torque" data-i18n="opt_le3">Torque-controlled (2da)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500" data-i18n="lbl_reinf">Cracking/Reinf (<span class="math-symbol">ψ<sub>c,V</sub></span>)</label>
                                <select id="psi_c_V_select" class="w-full border border-gray-300 rounded p-2 text-xs">
                                    <option value="1.0" data-i18n="opt_reinf1">No Reinf / < D13 (1.0)</option>
                                    <option value="1.2" data-i18n="opt_reinf2">Reinf ≥ D13 (1.2)</option>
                                    <option value="1.4" data-i18n="opt_reinf3">Reinf ≥ D13 + Ties (1.4)</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_en">Eccentric <span class="math-symbol">e'<sub>N</sub></span> [cm]</label>
                                    <input type="number" id="e_prime_n" value="0" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500" data-i18n="lbl_ev">Eccentric <span class="math-symbol">e'<sub>V</sub></span> [cm]</label>
                                    <input type="number" id="e_prime_v" value="0" class="calc-input w-full border border-gray-300 rounded p-2 text-right text-xs">
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Loads -->
                    <div class="px-6 pb-6">
                        <h4 class="text-xs font-bold text-eng-danger uppercase border-b pb-1 mb-2 text-red-600" data-i18n="sec_loads">Applied Loads</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-50 p-3 rounded border border-red-100">
                                <label class="text-xs font-bold text-red-700" data-i18n="lbl_t">Tension (<span class="math-symbol">T</span>) [kgf]</label>
                                <input type="number" id="loadT" value="1000" class="calc-input w-full border border-red-300 rounded p-1 mt-1 text-right text-red-800">
                            </div>
                            <div class="bg-red-50 p-3 rounded border border-red-100">
                                <label class="text-xs font-bold text-red-700" data-i18n="lbl_v">Shear (<span class="math-symbol">V</span>) [kgf]</label>
                                <input type="number" id="loadV" value="600" class="calc-input w-full border border-red-300 rounded p-1 mt-1 text-right text-red-800">
                            </div>
                            <!-- Step 6: Sustained Tension -->
                            <div class="bg-blue-50 p-3 rounded border border-blue-100 col-span-2">
                                <label class="text-xs font-bold text-blue-700" data-i18n="lbl_tsust">Sustained Tension (<span class="math-symbol">T<sub>sust</sub></span>) [kgf]</label>
                                <input type="number" id="loadT_sust" value="0" class="calc-input w-full border border-blue-300 rounded p-1 mt-1 text-right text-blue-800">
                            </div>
                            <!-- Step 11: Shear Direction -->
                            <div class="bg-orange-50 p-3 rounded border border-orange-100 col-span-2">
                                <label class="text-xs font-bold text-orange-700" data-i18n="lbl_v_dir">Shear Load Direction</label>
                                <select id="shear_dir" class="w-full border border-orange-300 rounded p-1 mt-1 text-xs text-orange-800">
                                    <option value="perp" data-i18n="opt_v_perp">Perpendicular (Standard)</option>
                                    <option value="para" data-i18n="opt_v_para">Parallel (2x Capacity)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 border-t border-gray-200">
                        <button onclick="performCalculation()" class="w-full bg-eng-primary hover:bg-blue-800 text-white font-bold py-3 px-6 rounded shadow-lg transform transition active:scale-[0.99] flex justify-center items-center">
                            <i class="fa-solid fa-gears mr-2"></i> <span data-i18n="btn_run">Run Structural Analysis</span>
                        </button>
                    </div>
                </div>

                <!-- RESULTS CONTAINER (Interactive View) -->
                <div id="results-container" class="hidden space-y-6">
                    <div class="bg-white rounded shadow border border-gray-200 p-2 flex justify-center gap-4">
                        <span class="text-xs font-bold text-gray-500 self-center" data-i18n="lbl_viz_mode">Visualization Mode:</span>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button onclick="changeVizMode('2d')" id="btn-viz-2d" class="px-4 py-1.5 text-xs font-medium bg-eng-primary text-white border border-eng-primary rounded-l-lg transition-colors" data-i18n="btn_viz_2d">
                                2D View (Default)
                            </button>
                            <button onclick="changeVizMode('3d')" id="btn-viz-3d" class="px-4 py-1.5 text-xs font-medium bg-white text-gray-700 border border-gray-200 rounded-r-lg hover:bg-gray-50 transition-colors" data-i18n="btn_viz_3d">
                                3D View
                            </button>
                        </div>
                    </div>
                    <!-- Step 7: Geometry Warnings -->
                    <div id="geo-warn-box" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm">
                        <p class="font-bold flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i><span data-i18n="warn_title">Geometry Violation</span></p>
                        <ul id="geo-warn-list" class="list-disc list-inside text-sm mt-1"></ul>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="saveResult()" id="save-btn" class="flex-1 bg-green-600 text-white py-2 rounded shadow hover:bg-green-700 transition font-bold text-sm">
                            <i class="fa-solid fa-cloud-arrow-up mr-2"></i><span data-i18n="btn_save">Save to Cloud</span>
                        </button>
                        <button onclick="printReport()" class="flex-1 bg-gray-700 text-white py-2 rounded shadow hover:bg-gray-800 transition font-bold text-sm">
                            <i class="fa-solid fa-print mr-2"></i><span data-i18n="btn_pdf">Download Report</span>
                        </button>
                    </div>

                    <!-- 3D Interactive Model -->
                    <div id="card-3d" class="bg-white rounded shadow border border-gray-200 overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-sm text-gray-700"><i class="fa-solid fa-cube mr-2"></i><span data-i18n="viz_3d">3D Interactive Model</span></h4>
                                <button onclick="reset3DView()" class="text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-0.5 rounded border border-gray-300 transition" title="Reset Camera">
                                    <i class="fa-solid fa-arrows-rotate"></i> <span data-i18n="btn_reset">Reset</span>
                                </button>
                            </div>
                            <span class="text-[10px] text-gray-400" data-i18n="lbl_3d_hint">Drag to Rotate | Scroll to Zoom</span>
                        </div>
                        <div id="canvas-3d-container" class="w-full h-64 bg-slate-900 relative">
                        </div>
                    </div>

                    <!-- Step 7: 2D Visualizer -->
                    <div id="card-viz" class="bg-white rounded shadow border border-gray-200 overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><i class="fa-solid fa-compass-drafting mr-2"></i><span data-i18n="viz_title">Layout Visualization</span></h4>
                        </div>
                        <div class="p-4 flex justify-center bg-slate-100">
                            <canvas id="viz-canvas" width="400" height="300" class="bg-white rounded shadow-sm border border-slate-300"></canvas>
                        </div>
                    </div>

                    <!-- Interaction Check Card (Step 4) -->
                    <div id="card-interaction" class="bg-slate-800 rounded shadow text-white">
                        <div class="p-3 border-b border-slate-700 flex justify-between items-center">
                            <h4 class="font-bold text-sm"><span data-i18n="res_int_title">Interaction Check</span> (Sec 17.8)</h4>
                            <span class="text-xs bg-slate-600 px-2 py-0.5 rounded font-mono">Max(N) + Max(V) ≤ 1.2</span>
                        </div>
                        <div class="p-4 grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-slate-700 p-2 rounded">
                                <span class="text-gray-400 text-xs block" data-i18n="res_max_n">Max Tension Ratio</span>
                                <span id="val-max-n" class="font-mono font-bold text-lg">0.00</span>
                            </div>
                            <div class="bg-slate-700 p-2 rounded">
                                <span class="text-gray-400 text-xs block" data-i18n="res_max_v">Max Shear Ratio</span>
                                <span id="val-max-v" class="font-mono font-bold text-lg">0.00</span>
                            </div>
                            <div class="col-span-2 border-t border-slate-600 pt-3 flex justify-between items-center">
                                <div>
                                    <span class="text-gray-400 text-xs block" data-i18n="res_sum">Interaction Sum</span>
                                    <span id="val-int-sum" class="font-mono font-bold text-xl text-yellow-400">0.00</span>
                                </div>
                                <div id="badge-int" class="px-4 py-2 rounded font-bold text-center bg-gray-600">Pending</div>
                            </div>
                        </div>
                    </div>

                    <!-- Steel Strength Card (Step 1) -->
                    <div id="card-steel" class="bg-white rounded border-l-4 border-l-gray-600 shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><span data-i18n="res_s_title">Anchor Steel Strength</span></h4>
                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600 font-mono">Sec 17.6.1 / 17.7.1</span>
                        </div>
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Tension Row 1 -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_nsa">Steel Tension (Nsa)</span><span id="r-nsa" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_nsa">φNsa Capacity</span><span id="r-phi-nsa" class="text-lg font-bold text-eng-primary"></span></div>

                                <!-- Tension Row 2 (Ratio & Check) -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-st-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check_t">Tension Check</span><span id="badge-st" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>

                                <div class="col-span-2 border-t my-1"></div>

                                <!-- Shear Row 1 -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_vsa">Steel Shear (Vsa)</span><span id="r-vsa" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_vsa">φVsa Capacity</span><span id="r-phi-vsa" class="text-lg font-bold text-eng-primary"></span></div>

                                <!-- Shear Row 2 (Ratio & Check) -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-sv-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check_v">Shear Check</span><span id="badge-sv" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Bond Strength Card (Step 3) -->
                    <div id="card-bond" class="bg-white rounded border-l-4 border-l-blue-600 shadow hidden">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><span data-i18n="res_b_title">Adhesive Bond Strength</span></h4>
                            <div class="flex gap-2">
                                <span id="badge-seis-bond" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold hidden">Seismic</span>
                                <span class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600 font-mono">Sec 17.6.5</span>
                            </div>
                        </div>
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_nba">Basic Bond (Nba)</span><span id="r-nba" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_cna">Crit. Spacing (cNa)</span><span id="r-cna" class="font-mono text-gray-600"></span></div>

                                <div><span class="text-gray-500 text-xs block" data-i18n="res_na">Bond Strength (Na)</span><span id="r-na" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_na">φNa Capacity</span><span id="r-phi-na" class="text-lg font-bold text-eng-primary"></span></div>

                                <div class="col-span-2 border-t pt-2 grid grid-cols-2 gap-4">
                                    <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-b-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                    <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-b" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                                </div>

                                <!-- Step 6: Sustained Check -->
                                <div id="row-sust" class="col-span-2 border-t pt-2 grid grid-cols-2 gap-4 bg-blue-50 p-2 rounded hidden">
                                    <div><span class="text-blue-800 text-xs block font-bold" data-i18n="res_sust_load">Sustained Load</span><span id="r-sust-load" class="font-mono font-bold text-blue-900"></span></div>
                                    <div><span class="text-blue-800 text-xs block font-bold" data-i18n="res_sust_check">Check (≤ 0.4φNa)</span><span id="badge-sust" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pullout & Pryout Card (Step 2) -->
                    <div id="card-pullout" class="bg-white rounded border-l-4 border-l-eng-warning shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><span data-i18n="res_p_title">Pullout & Pryout</span></h4>
                            <span id="badge-seis-pull" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold hidden">Seismic</span>
                        </div>
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Pullout Row -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_npn">Pullout (Npn)</span><span id="r-npn" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_npn">φNpn Capacity</span><span id="r-phi-npn" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-pn-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-pn" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>

                                <div class="col-span-2 border-t my-1"></div>

                                <!-- Pryout Row -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_vcp">Pryout (Vcp)</span><span id="r-vcp" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_vcp">φVcp Capacity</span><span id="r-phi-vcp" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-cp-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-cp" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 1. Tension Breakout (Combined) -->
                    <div id="card-tension" class="bg-white rounded border-l-4 border-l-eng-primary shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><span data-i18n="res_t_title">Concrete Tension Breakout</span></h4>
                            <span id="badge-seis-t" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold hidden">Seismic</span>
                        </div>

                        <!-- Single Tension Results -->
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm border-b">
                            <h5 class="font-bold text-gray-600 text-xs mb-2 uppercase" data-i18n="res_t1_sub">Single Anchor</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_nb">Basic Strength</span><span id="r1-nb" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_anc">Proj. Area</span><span id="r1-anc" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_cap">Capacity</span><span id="r1-cap" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r1-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-1" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                                <!-- Step 8: Splitting Factor Display -->
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_psi_cp">Splitting (ψcp)</span><span id="r1-psi-cp" class="font-mono text-gray-600">1.0</span></div>
                            </div>
                        </div>

                        <!-- Side-Face Blowout Row (Step 5) -->
                        <div id="row-sb" class="p-4 grid grid-cols-1 gap-2 text-sm border-b hidden bg-yellow-50">
                            <h5 class="font-bold text-yellow-700 text-xs mb-2 uppercase"><span data-i18n="res_sb_title">Side-Face Blowout</span> (Headed, deep)</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_nsb">Blowout Strength (Nsb)</span><span id="r-nsb" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_phi_nsb">φNsb Capacity</span><span id="r-phi-nsb" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r-sb-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-sb" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>

                        <!-- Group Tension Results -->
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm">
                            <h5 class="font-bold text-gray-600 text-xs mb-2 uppercase" data-i18n="res_tg_sub">Anchor Group</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_anc_g">Group Area</span><span id="r3-anc" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ecc">Eccentricity</span><span id="r3-psi" class="font-mono text-gray-600"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_cap_g">Group Capacity</span><span id="r3-cap" class="text-lg font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r3-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-3" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Shear Breakout (Combined) -->
                    <div id="card-shear" class="bg-white rounded border-l-4 border-l-eng-primary shadow">
                        <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                            <h4 class="font-bold text-sm text-gray-700"><span data-i18n="res_v_title">Concrete Shear Breakout</span></h4>
                            <span id="badge-seis-v" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold hidden">Seismic</span>
                        </div>
                        <!-- Single Shear Results -->
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm border-b">
                            <h5 class="font-bold text-gray-600 text-xs mb-2 uppercase" data-i18n="res_v1_sub">Single Anchor</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_vb">Basic Shear</span><span id="r2-vb" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_avc">Proj. Area</span><span id="r2-avc" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_cap">Capacity</span><span id="r2-cap" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r2-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-2" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>

                        <!-- NEW: Shear Lug Row -->
                        <div id="row-sl" class="p-4 grid grid-cols-1 gap-2 text-sm border-b hidden bg-gray-50">
                            <h5 class="font-bold text-gray-600 text-xs mb-2 uppercase">Shear Lug (Sec 17.11)</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block">Bearing (Vbrg)</span><span id="r-vbrg" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block">Breakout (Vcb,sl)</span><span id="r-vcbsl" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block">Capacity</span><span id="r-sl-cap" class="text-lg font-bold text-eng-primary"></span></div>
                                <div><span class="text-gray-500 text-xs block">Check</span><span id="badge-sl" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>

                        <!-- Group Shear Results -->
                        <div class="p-4 grid grid-cols-1 gap-2 text-sm">
                            <h5 class="font-bold text-gray-600 text-xs mb-2 uppercase" data-i18n="res_vg_sub">Anchor Group</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_avc_g">Group Area</span><span id="r4-avc" class="font-mono font-bold"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ecc">Eccentricity</span><span id="r4-psi" class="font-mono text-gray-600"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_cap_g">Group Capacity</span><span id="r4-cap" class="text-lg font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_ratio">Ratio</span><span id="r4-ratio" class="font-mono font-bold text-purple-700"></span></div>
                                <div><span class="text-gray-500 text-xs block" data-i18n="res_check">Check</span><span id="badge-4" class="text-xs px-2 py-0.5 rounded font-bold"></span></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB: HISTORY -->
            <div id="view-history" class="hidden">
                <!-- ... existing history code ... -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700" data-i18n="history_title">Database Records</h3>
                        <div class="flex space-x-3">
                            <button onclick="clearHistory()" class="text-red-500 text-sm hover:underline font-bold"><i class="fa-solid fa-trash mr-1"></i><span data-i18n="btn_clear">Clear All</span></button>
                            <button onclick="loadHistory()" class="text-eng-primary text-sm hover:underline"><i class="fa-solid fa-rotate mr-1"></i><span data-i18n="btn_refresh">Refresh</span></button>
                        </div>
                    </div>
                    <div id="history-list" class="divide-y divide-gray-200 max-h-[70vh] overflow-y-auto">
                        <div class="p-10 text-center text-gray-400 flex flex-col items-center">
                            <i class="fa-solid fa-server text-4xl mb-3 opacity-30"></i>
                            <p data-i18n="msg_auth_req">Authentication required to view records.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

    </div>

    <!-- PRINT STAGING AREA (Hidden on Screen, Visible on Print) -->
    <!-- MOVED OUTSIDE OF #ROOT TO PREVENT BEING HIDDEN BY CSS -->
    <div id="print-staging"></div>

    <!-- Logic Script -->
    <script>
        // ... existing firebase config ...
        const firebaseConfig = {
            apiKey: "AIzaSyAP0nsg3Saf_W0lEk5Mdt4oVKhFQJ69BOg",
            authDomain: "anchor-app-a1426.firebaseapp.com",
            projectId: "anchor-app-a1426",
            storageBucket: "anchor-app-a1426.firebasestorage.app",
            messagingSenderId: "822722897072",
            appId: "1:822722897072:web:32f8dabc44735718af0775",
            measurementId: "G-5GVPXDBJM1"
        };
        // ... existing auth init ...
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentData = null;
        let historyCache = {};
        let currentLang = 'en';

        // --- TRANSLATION DATA ---
// --- TRANSLATION DATA ---
        const translations = {
            en: {
                app_title: "Anchor Analysis", app_subtitle: "ACI/Structural Compliance Tool",
                tab_analysis: "Analysis", tab_database: "Database",
                sec_params: "Design Parameters", sec_mat: "Material & Geometry", sec_space: "Spacing & Edge Dist", sec_factors: "Factors & Coefficients", sec_loads: "Applied Loads",
                sec_steel_props: "ANCHOR STEEL",
                lbl_fc: "Concrete Strength (<span class='math-symbol'>f'c</span>) [kgf/cm²]", lbl_ha: "Base Thickness (<span class='math-symbol'>h<sub>a</sub></span>) [cm]", lbl_da: "Diameter (<span class='math-symbol'>d<sub>a</sub></span>) [cm]", lbl_hef: "Embedment (<span class='math-symbol'>h<sub>ef</sub></span>) [cm]",
                lbl_s1: "Vertical Spacing (<span class='math-symbol'>S<sub>1</sub></span>) [cm]", lbl_s2: "Horizontal Spacing (<span class='math-symbol'>S<sub>2</sub></span>) [cm]", lbl_ca1: "Top Edge (<span class='math-symbol'>C<sub>a1</sub></span>) [cm]", lbl_ca1_1: "Bottom Edge (<span class='math-symbol'>C<sub>a1,1</sub></span>) [cm]", lbl_ca2: "Side Edge (<span class='math-symbol'>C<sub>a2</sub></span>) [cm]",
                lbl_kc: "Anchor Type (<span class='math-symbol'>k<sub>c</sub></span>)", lbl_lambda: "Failure Factor (<span class='math-symbol'>λ<sub>a</sub></span>)", lbl_le: "Load Length (<span class='math-symbol'>l<sub>e</sub></span>)", lbl_reinf: "Cracking/Reinf (<span class='math-symbol'>ψ<sub>c,V</sub></span>)", lbl_en: "Eccentric <span class='math-symbol'>e'<sub>N</sub></span> [cm]", lbl_ev: "Eccentric <span class='math-symbol'>e'<sub>V</sub></span> [cm]",
                lbl_ase: "Eff. Area (<span class='math-symbol'>A<sub>se</sub></span>) [cm²]", lbl_futa: "Ult (<span class='math-symbol'>f<sub>uta</sub></span>)", lbl_fya: "Yld (<span class='math-symbol'>f<sub>ya</sub></span>)", lbl_grouted: "Grouted (0.8x Shear)",
                lbl_pull_mode: "Pullout Mode", lbl_abrg: "Bearing Area (<span class='math-symbol'>A<sub>brg</sub></span>) [cm²]", lbl_eh: "Hook Length (<span class='math-symbol'>e<sub>h</sub></span>) [cm]", lbl_np_cert: "Certified Pullout (<span class='math-symbol'>N<sub>p</sub></span>) [kgf]", lbl_crack_p: "Pullout Cracking (<span class='math-symbol'>ψ<sub>c,P</sub></span>)",
                lbl_is_adh: "Adhesive Anchor", lbl_tau: "Bond Stress (<span class='math-symbol'>τ</span>) [kgf/cm²]",
                lbl_cond: "Condition (Reinf)", lbl_cat: "Category (Rel.)", lbl_ductility: "Ductility",
                lbl_seismic: "Seismic Design (0.75 Reduction)",
                lbl_t: "Tension (<span class='math-symbol'>T</span>) [kgf]", lbl_v: "Shear (<span class='math-symbol'>V</span>) [kgf]",
                lbl_tsust: "Sustained Tension (<span class='math-symbol'>T<sub>sust</sub></span>) [kgf]",
                lbl_cac: "Critical Edge Dist (<span class='math-symbol'>c<sub>ac</sub></span>) [cm]",
                lbl_v_dir: "Shear Load Direction",
                lbl_is_sl: "Shear Lug (Sec 17.11)", lbl_is_reinf: "Anchor Reinf. Present?",
                lbl_stretch: "Stretch Length (<span class='math-symbol'>L<sub>str</sub></span>) [cm]",
                btn_run: "Run Structural Analysis", btn_save: "Save to Cloud", btn_pdf: "Download Report",
                opt_cast: "Cast-in Anchors (10)", opt_post: "Post-installed (7)",
                opt_lam1: "Cast-in/Undercut (1.0)", opt_lam2: "Expansion/Bonded (0.8)", opt_lam3: "Bonded Failure (0.6)",
                opt_le1: "Default/All (8da)", opt_le2: "Full Sleeve/Headed (hef)", opt_le3: "Torque-controlled (2da)",
                opt_reinf1: "No Reinf / < D13 (1.0)", opt_reinf2: "Reinf ≥ D13 (1.2)", opt_reinf3: "Reinf ≥ D13 + Ties (1.4)",
                opt_headed: "Headed Bolt/Stud", opt_hooked: "Hooked Bolt (J/L)", opt_post_cert: "Post-installed (Cert.)", opt_uncracked: "Uncracked (1.4)", opt_cracked: "Cracked (1.0)",
                opt_cond_a: "A (Reinforced)", opt_cond_b: "B (No Reinf)", opt_ductile: "Ductile", opt_brittle: "Brittle",
                opt_v_perp: "Perpendicular (Standard)", opt_v_para: "Parallel (2x Capacity)",
                opt_screw: "Screw Anchor",
                res_s_title: "Anchor Steel Strength", res_nsa: "Steel Tension (Nsa)", res_phi_nsa: "φNsa Capacity", res_vsa: "Steel Shear (Vsa)", res_phi_vsa: "φVsa Capacity", res_check_t: "Tension Check", res_check_v: "Shear Check",
                res_p_title: "Pullout & Pryout", res_npn: "Pullout (Npn)", res_phi_npn: "φNpn Capacity", res_vcp: "Pryout (Vcp)", res_phi_vcp: "φVcp Capacity",
                res_b_title: "Adhesive Bond Strength", res_nba: "Basic Bond (Nba)", res_cna: "Crit. Spacing (cNa)", res_na: "Bond Strength (Na)", res_phi_na: "φNa Capacity",
                res_sust_load: "Sustained Load", res_sust_check: "Check (≤ 0.4φNa)",
                res_int_title: "Interaction Check", res_max_n: "Max Tension Ratio", res_max_v: "Max Shear Ratio", res_sum: "Interaction Sum",
                res_t_title: "Concrete Tension Breakout", res_t1_sub: "Single Anchor", res_tg_sub: "Anchor Group",
                res_sb_title: "Side-Face Blowout", res_nsb: "Blowout Strength (Nsb)", res_phi_nsb: "φNsb Capacity",
                res_v_title: "Concrete Shear Breakout", res_v1_sub: "Single Anchor", res_vg_sub: "Anchor Group",
                res_nb: "Basic Strength", res_anc: "Proj. Area", res_anc_g: "Group Area", res_anco: "Ref. Area", res_edge: "Edge Factor", res_cap: "Capacity", res_cap_g: "Group Capacity", res_load: "Load", res_ratio: "Ratio", res_check: "Check",
                res_psi_cp: "Splitting (ψcp)",
                res_vb: "Basic Shear", res_h: "Height Factor", res_avc: "Proj. Area", res_avc_g: "Group Area", res_avco: "Ref. Area", res_ecc: "Eccentricity",
                modal_title: "Access Portal", modal_desc: "Sign in to sync your data across devices.", btn_login: "Login", btn_login_submit: "Login", btn_register: "Register", btn_guest: "Continue as Guest",
                history_title: "Database Records", btn_clear: "Clear All", btn_refresh: "Refresh", msg_auth_req: "Authentication required to view records.", msg_no_rec: "No records found.",
                open: "Open", pass: "PASS", fail: "FAIL",
                warn_title: "Geometry Violation", viz_title: "Layout Visualization", viz_3d: "3D Interactive Model",

                // --- NEW TRANSLATIONS ADDED BELOW ---
                lbl_sl_h: "Height (cm)",
                lbl_sl_w: "Width (cm)",
                lbl_sl_t: "Thickness (cm)",
                lbl_sl_c: "Edge Dist (cm)",
                opt_cat1: "1 (High Rel)",
                opt_cat2: "2 (Med Rel)",
                opt_cat3: "3 (Low Rel)",
                msg_cac_default: "Default: 2.5hef (Undercut) or 4hef (Exp)",
                tbl_res_type: "Result Type",
                tbl_factor: "Factor",
                tbl_note: "Note",
                tbl_param: "Parameter",
                tbl_check: "Check Item",
                tbl_eq: "Equations",
                tbl_val: "Value",
                tbl_unit: "Unit",
                tbl_stat: "Status",
                tbl_ratio_lbl: "Load / Capacity",
                lbl_layout: "Anchor Layout",
                val_yes: "Yes",
                val_no: "No",
                opt_grid: "Grid (S1/S2)",
                opt_custom: "Custom (X,Y)",
                msg_spacing_note: "Uses Vertical/Horizontal Spacing below.",
                lbl_gen_title: "1. Grid Generator",
                lbl_rows: "Rows (Y)",
                lbl_cols: "Cols (X)",
                lbl_action: "Action",
                btn_add_grid: "Add Grid",
                lbl_sp_x: "Space X",
                lbl_sp_y: "Space Y",
                lbl_st_x: "Start X",
                lbl_st_y: "Start Y",
                lbl_list_title: "2. Anchor List",
                btn_clear_all: "Clear All",
                tbl_head_num: "#",
                tbl_head_x: "X (cm)",
                tbl_head_y: "Y (cm)",
                tbl_head_action:  "Action",
                msg_no_def: "No anchors defined",
                btn_add_pt: "Add Point",
                lbl_reinf_area: "Area (cm²)",
                lbl_reinf_yield: "Yield (kgf/cm²)",
                lbl_viz_mode: "Visualization Mode:",
                btn_viz_2d: "2D View (Default)",
                btn_viz_3d: "3D View",
                btn_reset: "Reset",
                lbl_3d_hint: "Drag to Rotate | Scroll to Zoom",
                warn_custom_empty: "Custom coordinates empty. Using default 2x2 grid.",
                rpt_layout: "Layout Confirmation"
            },
            zh: {
                app_title: "錨栓設計分析", app_subtitle: "ACI/結構規範檢核工具",
                tab_analysis: "結構分析", tab_database: "資料庫",
                sec_params: "設計參數", sec_mat: "材料與幾何", sec_space: "間距與邊距", sec_factors: "修正因數/參數", sec_loads: "設計載重",
                sec_steel_props: "錨栓鋼材性質",
                lbl_fc: "混凝土抗壓強度 (<span class='math-symbol'>f'c</span>) [kgf/cm²]", lbl_ha: "母材構件 (<span class='math-symbol'>h<sub>a</sub></span>) [cm]", lbl_da: "錨栓直徑 (<span class='math-symbol'>d<sub>a</sub></span>) [cm]", lbl_hef: "錨栓埋入深度 (<span class='math-symbol'>h<sub>ef</sub></span>) [cm]",
                lbl_s1: "錨栓垂直間距 (<span class='math-symbol'>S<sub>1</sub></span>) [cm]", lbl_s2: "錨栓水平間距 (<span class='math-symbol'>S<sub>2</sub></span>) [cm]", lbl_ca1: "上方錨栓距梁頂邊 (<span class='math-symbol'>C<sub>a1</sub></span>) [cm]", lbl_ca1_1: "下方錨栓距梁底邊 (<span class='math-symbol'>C<sub>a1,1</sub></span>) [cm]", lbl_ca2: "錨栓距梁邊 (<span class='math-symbol'>C<sub>a2</sub></span>) [cm]",
                lbl_kc: "錨栓類型 (<span class='math-symbol'>k<sub>c</sub></span>)", lbl_lambda: "混凝土破壞參數 (<span class='math-symbol'>λ<sub>a</sub></span>)", lbl_le: "承壓長度模式 (<span class='math-symbol'>l<sub>e</sub></span>)", lbl_reinf: "開裂/配筋參數 (<span class='math-symbol'>ψ<sub>c,V</sub></span>)", lbl_en: "偏心距 <span class='math-symbol'>e'<sub>N</sub></span> [cm]", lbl_ev: "偏心距 <span class='math-symbol'>e'<sub>V</sub></span> [cm]",
                lbl_ase: "有效斷面積 (<span class='math-symbol'>A<sub>se</sub></span>) [cm²]", lbl_futa: "極限強度 (<span class='math-symbol'>f<sub>uta</sub></span>)", lbl_fya: "降伏強度 (<span class='math-symbol'>f<sub>ya</sub></span>)", lbl_grouted: "灌漿錨栓 (0.8x 剪力)",
                lbl_pull_mode: "拉出模式", lbl_abrg: "承壓面積 (<span class='math-symbol'>A<sub>brg</sub></span>) [cm²]", lbl_eh: "彎鉤長度 (<span class='math-symbol'>e<sub>h</sub></span>) [cm]", lbl_np_cert: "認證拉出強度 (<span class='math-symbol'>N<sub>p</sub></span>) [kgf]", lbl_crack_p: "拉出開裂參數 (<span class='math-symbol'>ψ<sub>c,P</sub></span>)",
                lbl_is_adh: "化學黏結錨栓", lbl_tau: "黏結強度 (<span class='math-symbol'>τ</span>) [kgf/cm²]",
                lbl_cond: "混凝土狀況", lbl_cat: "錨栓類別 (可靠度)", lbl_ductility: "延展性",
                lbl_seismic: "耐震設計 (0.75 折減)",
                lbl_t: "拉力設計載重 (<span class='math-symbol'>T</span>) [kgf]", lbl_v: "剪力設計載重 (<span class='math-symbol'>V</span>) [kgf]",
                lbl_tsust: "長期拉力載重 (<span class='math-symbol'>T<sub>sust</sub></span>) [kgf]",
                lbl_cac: "臨界邊距 (<span class='math-symbol'>c<sub>ac</sub></span>) [cm]",
                lbl_v_dir: "剪力載重方向",
                lbl_is_sl: "剪力榫 (Sec 17.11)", lbl_is_reinf: "有錨栓鋼筋?",
                lbl_stretch: "延伸長度 (<span class='math-symbol'>L<sub>str</sub></span>) [cm]",
                btn_run: "執行結構分析", btn_save: "儲存至雲端", btn_pdf: "下載報告",
                opt_cast: "預埋式錨栓 (10)", opt_post: "後置式錨栓 (7)",
                opt_lam1: "預埋/擴底錨栓 (1.0)", opt_lam2: "膨脹/黏結錨栓 (0.8)", opt_lam3: "黏結破壞 (0.6)",
                opt_le1: "預設/所有情況 (8da)", opt_le2: "全套筒/擴頭 (hef)", opt_le3: "扭力控制 (2da)",
                opt_reinf1: "無輔助鋼筋 / < D13 (1.0)", opt_reinf2: "配筋 ≥ D13 (1.2)", opt_reinf3: "配筋 ≥ D13 + 箍筋 (1.4)",
                opt_headed: "擴頭螺栓/釘 (Headed)", opt_hooked: "彎鉤螺栓 (Hooked)", opt_post_cert: "後置式 (認證值)", opt_uncracked: "未開裂 (1.4)", opt_cracked: "開裂 (1.0)",
                opt_cond_a: "A (有輔助筋)", opt_cond_b: "B (無輔助筋)", opt_ductile: "延展性 (Ductile)", opt_brittle: "脆性 (Brittle)",
                opt_v_perp: "垂直於邊距 (標準)", opt_v_para: "平行於邊距 (2x 強度)",
                opt_screw: "螺紋錨栓 (Screw)",
                res_s_title: "錨栓鋼材強度檢核", res_nsa: "鋼材拉力 (Nsa)", res_phi_nsa: "φNsa 強度", res_vsa: "鋼材剪力 (Vsa)", res_phi_vsa: "φVsa 強度", res_check_t: "拉力檢核", res_check_v: "剪力檢核",
                res_p_title: "拉出與撬破檢核", res_npn: "拉出強度 (Npn)", res_phi_npn: "φNpn 強度", res_vcp: "撬破強度 (Vcp)", res_phi_vcp: "φVcp 強度",
                res_b_title: "化學錨栓黏結強度", res_nba: "基本黏結 (Nba)", res_cna: "臨界間距 (cNa)", res_na: "黏結強度 (Na)", res_phi_na: "φNa 強度",
                res_sust_load: "長期拉力載重", res_sust_check: "長期檢核 (≤ 0.4φNa)",
                res_int_title: "交互作用檢核", res_max_n: "最大拉力比", res_max_v: "最大剪力比", res_sum: "交互作用值",
                res_t_title: "混凝土拉破檢核", res_t1_sub: "單根錨栓", res_tg_sub: "錨栓群",
                res_sb_title: "側面爆裂檢核", res_nsb: "爆裂強度 (Nsb)", res_phi_nsb: "φNsb 強度",
                res_v_title: "混凝土剪破檢核", res_v1_sub: "單根錨栓", res_vg_sub: "錨栓群",
                res_nb: "基本拉破強度", res_anc: "破壞投影面積", res_anc_g: "群錨面積", res_anco: "參考面積", res_edge: "邊距修正因數", res_cap: "強度", res_cap_g: "群錨強度", res_load: "載重", res_ratio: "比值", res_check: "檢核",
                res_psi_cp: "劈裂因數 (ψcp)",
                res_vb: "基本剪破強度", res_h: "厚度修正因數", res_avc: "破壞投影面積", res_avc_g: "群錨面積", res_avco: "參考面積", res_ecc: "偏心修正因數",
                modal_title: "存取入口", modal_desc: "登入以同步您的資料。", btn_login: "登入", btn_login_submit: "登入", btn_register: "註冊", btn_guest: "訪客登入",
                history_title: "資料庫紀錄", btn_clear: "清除全部", btn_refresh: "重新整理", msg_auth_req: "需驗證才能查看紀錄。", msg_no_rec: "找不到紀錄。",
                open: "開啟", pass: "通過", fail: "失敗",
                warn_title: "幾何限制警告", viz_title: "配置可視化", viz_3d: "3D 互動模型",

                // --- NEW TRANSLATIONS ADDED BELOW ---
                lbl_sl_h: "高度 (cm)",
                lbl_sl_w: "寬度 (cm)",
                lbl_sl_t: "厚度 (cm)",
                lbl_sl_c: "邊距 (cm)",
                opt_cat1: "1 (高可靠度)",
                opt_cat2: "2 (中可靠度)",
                opt_cat3: "3 (低可靠度)",
                msg_cac_default: "預設值: 2.5hef (擴底式) 或 4hef (膨脹式)",
                tbl_res_type: "結果類型",
                tbl_factor: "係數/參數",
                tbl_note: "備註",
                tbl_param: "參數名稱",
                tbl_check: "檢核項目",
                tbl_eq: "公式",
                tbl_val: "數值",
                tbl_unit: "單位",
                tbl_stat: "狀態",
                tbl_ratio_lbl: "載重 / 強度",
                lbl_layout: "錨栓配置",
                val_yes: "是",
                val_no: "否",
                opt_grid: "網格 (S1/S2)",
                opt_custom: "自訂 (X,Y)",
                msg_spacing_note: "使用下方的垂直/水平間距。",
                lbl_gen_title: "1. 網格生成器",
                lbl_rows: "列數 (Y)",
                lbl_cols: "行數 (X)",
                lbl_action: "動作",
                btn_add_grid: "新增網格",
                lbl_sp_x: "間距 X",
                lbl_sp_y: "間距 Y",
                lbl_st_x: "起點 X",
                lbl_st_y: "起點 Y",
                lbl_list_title: "2. 錨栓清單",
                btn_clear_all: "清除全部",
                tbl_head_num: "#",
                tbl_head_x: "X (cm)",
                tbl_head_y: "Y (cm)",
                tbl_head_action:  "動作",
                msg_no_def: "尚未定義錨栓",
                btn_add_pt: "新增點",
                lbl_reinf_area: "面積 (cm²)",
                lbl_reinf_yield: "降伏強度 (kgf/cm²)",
                lbl_viz_mode: "檢視模式:",
                btn_viz_2d: "2D 視圖 (預設)",
                btn_viz_3d: "3D 視圖",
                btn_reset: "重置",
                lbl_3d_hint: "拖曳旋轉 | 滾輪縮放",
                warn_custom_empty: "自訂座標為空。使用預設 2x2 網格。",
                rpt_layout: "配置確認圖"
            }
        };

        // --- FORMULA IMAGES (SVG) ---
        // Detailed Formula Images for PDF Header
        const math_Nb_pdf = `<svg height="30" viewBox="0 0 250 30" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><text x="0" y="22" font-family="Times New Roman" font-size="18" font-style="italic">N<tspan dy="5" font-size="12">b</tspan><tspan dy="-5" font-size="18"> = </tspan>k<tspan dy="5" font-size="12">c</tspan><tspan dy="-5" font-size="18"> </tspan>λ<tspan dy="5" font-size="12">a</tspan><tspan dy="-5" font-size="18"> √f'</tspan><tspan dy="5" font-size="12">c</tspan><tspan dy="-5" font-size="18"> h</tspan><tspan dy="5" font-size="12">ef</tspan><tspan dy="-10" font-size="12">1.5</tspan></text></svg>`;
        const math_Vb_pdf = `<svg height="30" viewBox="0 0 250 30" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><text x="0" y="22" font-family="Times New Roman" font-size="18" font-style="italic">V<tspan dy="5" font-size="12">b</tspan><tspan dy="-5" font-size="18"> = min(V</tspan><tspan dy="5" font-size="12">b1</tspan><tspan dy="-5" font-size="18">, V</tspan><tspan dy="5" font-size="12">b2</tspan><tspan dy="-5" font-size="18">)</tspan></text></svg>`;
        const math_Ncbg_pdf = `<svg height="30" viewBox="0 0 450 30" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><text x="0" y="22" font-family="Times New Roman" font-size="18" font-style="italic">φN<tspan dy="5" font-size="12">cbg</tspan><tspan dy="-5" font-size="18"> = φ (A</tspan><tspan dy="5" font-size="12">Nc</tspan><tspan dy="-5" font-size="18">/A</tspan><tspan dy="5" font-size="12">Nco</tspan><tspan dy="-5" font-size="18">) ψ</tspan><tspan dy="5" font-size="12">ec,N</tspan><tspan dy="-5" font-size="18"> ψ</tspan><tspan dy="5" font-size="12">ed,N</tspan><tspan dy="-5" font-size="18"> ψ</tspan><tspan dy="5" font-size="12">c,N</tspan><tspan dy="-5" font-size="18"> ψ</tspan><tspan dy="5" font-size="12">cp,N</tspan><tspan dy="-5" font-size="18"> N</tspan><tspan dy="5" font-size="12">b</tspan></text></svg>`;
        const math_Vcbg_pdf = `<svg height="30" viewBox="0 0 450 30" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><text x="0" y="22" font-family="Times New Roman" font-size="18" font-style="italic">φV<tspan dy="5" font-size="12">cbg</tspan><tspan dy="-5" font-size="18"> = φ (A</tspan><tspan dy="5" font-size="12">Vc</tspan><tspan dy="-5" font-size="18">/A</tspan><tspan dy="5" font-size="12">Vco</tspan><tspan dy="-5" font-size="18">) ψ</tspan><tspan dy="5" font-size="12">ec,V</tspan><tspan dy="-5" font-size="18"> ψ</tspan><tspan dy="5" font-size="12">ed,V</tspan><tspan dy="-5" font-size="18"> ψ</tspan><tspan dy="5" font-size="12">h,V</tspan><tspan dy="-5" font-size="18"> V</tspan><tspan dy="5" font-size="12">b</tspan></text></svg>`;

        function t(key) { return translations[currentLang][key] || key; }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            document.getElementById('lang-label').innerText = currentLang === 'en' ? '中文' : 'EN';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) el.innerHTML = translations[currentLang][key];
            });
            if (currentData) updateUI();
            if (!document.getElementById('view-history').classList.contains('hidden')) loadHistory();
        }

        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                const label = user.email ? user.email : `Guest: ${user.uid.substring(0, 6)}`;
                document.getElementById('user-email').innerText = label;
                if (!document.getElementById('view-history').classList.contains('hidden')) loadHistory();
            } else {
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => document.getElementById('auth-modal').classList.remove('hidden'));
        document.getElementById('guest-login').addEventListener('click', async () => { await auth.signInAnonymously(); document.getElementById('auth-modal').classList.add('hidden'); });
        // --- EMAIL LOGIN LOGIC ---
        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMsg = document.getElementById('auth-error');
       
            // Reset error
            errorMsg.classList.add('hidden');
            errorMsg.innerText = '';
       
            if (!email || !password) {
                errorMsg.innerText = "Please enter both email and password.";
                errorMsg.classList.remove('hidden');
                return;
            }
       
            try {
                // Change button text to indicate loading
                const btn = document.getElementById('email-login-btn');
                const originalText = btn.innerText;
                btn.innerText = 'Processing...';
       
                await auth.signInWithEmailAndPassword(email, password);
               
                // Modal will close automatically via the onAuthStateChanged listener you already wrote
               
                // Reset button text
                btn.innerText = originalText;
            } catch (error) {
                console.error(error);
                errorMsg.innerText = error.message;
                errorMsg.classList.remove('hidden');
                document.getElementById('email-login-btn').innerText = "Login";
            }
        });
       
        // --- EMAIL REGISTER LOGIC ---
        document.getElementById('email-register-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMsg = document.getElementById('auth-error');
       
            // Reset error
            errorMsg.classList.add('hidden');
            errorMsg.innerText = '';
       
            if (!email || !password) {
                errorMsg.innerText = "Please enter both email and password.";
                errorMsg.classList.remove('hidden');
                return;
            }
       
            try {
                const btn = document.getElementById('email-register-btn');
                const originalText = btn.innerText;
                btn.innerText = 'Creating...';
       
                await auth.createUserWithEmailAndPassword(email, password);
               
                // Modal closes automatically via onAuthStateChanged
               
                btn.innerText = originalText;
            } catch (error) {
                console.error(error);
                errorMsg.innerText = error.message;
                errorMsg.classList.remove('hidden');
                document.getElementById('email-register-btn').innerText = "Register";
            }
        });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); window.location.reload(); });

        window.togglePulloutInputs = function() {
            const mode = document.getElementById('pullout_mode').value;
            document.getElementById('div_abrg').classList.toggle('hidden', mode !== 'headed');
            document.getElementById('div_eh').classList.toggle('hidden', mode !== 'hooked');
            document.getElementById('div_np').classList.toggle('hidden', mode !== 'post');
        }

        // NEW Step 3: Toggle Adhesive
        window.toggleAdhesive = function() {
            const isAdh = document.getElementById('is_adhesive').checked;
            document.getElementById('div_adhesive').classList.toggle('hidden', !isAdh);
        }

        // NEW Feature: Toggle Shear Lug Inputs
        window.toggleShearLug = function() {
            const isSL = document.getElementById('is_shearlug').checked;
            document.getElementById('div_shearlug').classList.toggle('hidden', !isSL);
        }

        // NEW Feature: Toggle Reinforcement Inputs
        window.toggleReinf = function() {
            const isRe = document.getElementById('is_reinf').checked;
            document.getElementById('div_reinf').classList.toggle('hidden', !isRe);
        }
        // NEW Feature: Toggle Seismic Detailing Input
        window.toggleSeismicDetailing = function() {
            const isSeis = document.getElementById('is_seismic').checked;
            const isDuctile = document.getElementById('steel_ductility').value === 'ductile';
            document.getElementById('div_stretch').classList.toggle('hidden', !(isSeis && isDuctile));
        }
        // NEW Feature: Auto-calculate Critical Edge Distance (Lookup Logic)
        window.updateCac = function () {
            const hef = parseFloat(document.getElementById('hef').value) || 0;
            const type = document.getElementById('kc_select').value;
            let factor = 0;

            // ACI 318 Default assumptions for Critical Edge Distance
            if (type === '7') factor = 4.0; // Expansion anchors default
            else if (type === 'screw') factor = 2.5; // Screw/Undercut anchors default
            else factor = 0; // Cast-in usually relies on cover/spacing, not cac splitting check

            // Only auto-update if a factor applies
            if (factor > 0) {
                document.getElementById('cac').value = (hef * factor).toFixed(2);
            }
            performCalculation(); // Live update results
        }

        let scene, camera, renderer, controls;
        let currentVizMode = '2d';

// --- NEW: Custom Anchor Manager ---
        let anchorData = []; 

        // Helper to parse hidden textarea back to array
        function parseCoords() {
            const raw = document.getElementById('custom_coords').value.trim();
            if(!raw) return [];
            return raw.split(';').map(s => {
                const p = s.trim().split(',');
                return { x: parseFloat(p[0])||0, y: parseFloat(p[1])||0 };
            });
        }

        // Sync Array -> Hidden Textarea -> Calculation
        function syncToTextarea() {
            const str = anchorData.map(a => `${a.x},${a.y}`).join(' ; ');
            document.getElementById('custom_coords').value = str;
            performCalculation();
        }

        // Render the visual table
        function renderAnchorTable() {
            const tbody = document.getElementById('anchor_table_body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            if(anchorData.length === 0) {
                // UPDATE: Added translation support for this message
                const msg = translations[currentLang]['msg_no_def'] || "No anchors defined";
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-2 italic">${msg}</td></tr>`;
                return;
            }

            anchorData.forEach((a, i) => {
                const tr = document.createElement('tr');
                tr.className = "border-b last:border-0 hover:bg-blue-50";
                tr.innerHTML = `
                    <td class="p-1 pl-2 text-gray-500">${i+1}</td>
                    <td class="p-1 font-mono font-bold text-eng-primary">${a.x}</td>
                    <td class="p-1 font-mono font-bold text-eng-primary">${a.y}</td>
                    <td class="p-1 text-right pr-2">
                        <button onclick="removeAnchor(${i})" class="text-red-400 hover:text-red-600 px-1"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Layout Actions ---
        window.addSingleAnchor = function() {
            const x = parseFloat(document.getElementById('new_x').value);
            const y = parseFloat(document.getElementById('new_y').value);
            if(isNaN(x) || isNaN(y)) return;
            anchorData.push({x, y});
            renderAnchorTable();
            syncToTextarea();
            document.getElementById('new_x').value = '';
            document.getElementById('new_y').value = '';
        };

        window.removeAnchor = function(idx) {
            anchorData.splice(idx, 1);
            renderAnchorTable();
            syncToTextarea();
        };

        window.clearAllAnchors = function() {
            if(!confirm("Clear all custom anchors?")) return;
            anchorData = [];
            renderAnchorTable();
            syncToTextarea();
        };

        // Updated Generator with Offsets
        window.generateGridAnchors = function () {
            const rows = parseInt(document.getElementById('grid_rows').value) || 1;
            const cols = parseInt(document.getElementById('grid_cols').value) || 1;
            const sx = parseFloat(document.getElementById('grid_sx').value) || 0;
            const sy = parseFloat(document.getElementById('grid_sy').value) || 0;
            const stx = parseFloat(document.getElementById('grid_st_x').value) || 0;
            const sty = parseFloat(document.getElementById('grid_st_y').value) || 0;
            
            // Append new grid to existing list
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    anchorData.push({ 
                        x: parseFloat((stx + j * sx).toFixed(2)), 
                        y: parseFloat((sty + i * sy).toFixed(2)) 
                    });
                }
            }
            renderAnchorTable();
            syncToTextarea();
        };

        // Layout Toggle
        window.toggleLayoutMode = function () {
            const mode = document.getElementById('layout_mode').value;
            const isCustom = mode === 'custom';
            
            // Show/hide the Custom Table UI
            document.getElementById('div_custom_coords').classList.toggle('hidden', !isCustom);
            
            // Grey out Spacing & Edge inputs instead of hiding the section
            const spacingSection = document.getElementById('spacing-inputs-section');
            const inputs = spacingSection.querySelectorAll('input');
            
            inputs.forEach(input => {
                input.disabled = isCustom;
                if (isCustom) {
                    input.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed', 'border-gray-200');
                    input.classList.remove('border-gray-300');
                } else {
                    input.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed', 'border-gray-200');
                    input.classList.add('border-gray-300');
                }
            });

            if (isCustom) {
                if (anchorData.length === 0) anchorData = parseCoords();
                renderAnchorTable();
            }
            performCalculation();
        };

        window.changeVizMode = function (mode) {
            currentVizMode = mode;
            const btn2d = document.getElementById('btn-viz-2d');
            const btn3d = document.getElementById('btn-viz-3d');
            btn2d.className = (mode === '2d') ? "px-4 py-1.5 text-xs font-medium bg-eng-primary text-white border border-eng-primary rounded-l-lg" : "px-4 py-1.5 text-xs font-medium bg-white text-gray-700 border border-gray-200 rounded-l-lg";
            btn3d.className = (mode === '3d') ? "px-4 py-1.5 text-xs font-medium bg-eng-primary text-white border border-eng-primary rounded-r-lg" : "px-4 py-1.5 text-xs font-medium bg-white text-gray-700 border border-gray-200 rounded-r-lg";

            // Initialize 3D when switching to 3D mode
            if (mode === '3d' && !renderer) {
                setTimeout(() => {
                    init3D();
                    if (currentData && currentData.anchors) {
                        update3DScene(currentData.anchors, currentData.inputs);
                    }
                }, 100);
            }

            updateUI();
        };

        window.init3D = function () {
            const container = document.getElementById('canvas-3d-container');
            if (!container) return;

            // Clear existing renderer if present
            if (renderer) {
                container.removeChild(renderer.domElement);
                renderer.dispose();
                renderer = null;
            }

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);

            const width = container.clientWidth || 800;
            const height = container.clientHeight || 256;

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(60, 60, 60);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const spotLight = new THREE.SpotLight(0xffffff, 0.5);
            spotLight.position.set(100, 100, 100);
            scene.add(spotLight);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.update();

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                if (currentVizMode === '3d') renderer.render(scene, camera);
            }
            animate();
        };

        window.update3DScene = function (anchors, I) {
            if (!renderer) init3D();

            // Remove old meshes
            scene.children.filter(c => c.type === "Mesh").forEach(m => scene.remove(m));

            // 1. Concrete Slab - Calculate based on actual anchor positions
            let maxAnchorX = 0;
            let maxAnchorY = 0;

            if (anchors.length > 0) {
                maxAnchorX = Math.max(...anchors.map(a => a.x));
                maxAnchorY = Math.max(...anchors.map(a => a.y));
            }

            const slabW = maxAnchorX + I.ca2 * 2 + 10; // max anchor X + edge distances + margin
            const slabH = maxAnchorY + I.ca1 * 2 + 10; // max anchor Y + edge distances + margin
            const slabGeo = new THREE.BoxGeometry(slabW, I.ha, slabH);
            const slabMat = new THREE.MeshPhongMaterial({ color: 0x475569, transparent: true, opacity: 0.6 });
            const slab = new THREE.Mesh(slabGeo, slabMat);
            slab.position.y = -I.ha / 2;
            scene.add(slab);

            // 2. Anchors
            anchors.forEach(a => {
                const rodGeo = new THREE.CylinderGeometry(I.da / 2, I.da / 2, I.hef + 2, 16);
                const rodMat = new THREE.MeshPhongMaterial({ color: 0xe2e8f0 });
                const rod = new THREE.Mesh(rodGeo, rodMat);
                rod.position.set(a.x - slabW / 2 + I.ca2, -I.hef / 2, a.y - slabH / 2 + I.ca1);
                scene.add(rod);
            });
            // Reset camera to see all anchors
            const maxDim = Math.max(slabW, slabH, I.ha);
            const distance = maxDim * 2;
            camera.position.set(distance, distance, distance);
            camera.lookAt(0, 0, 0);
            controls.update();

            renderer.render(scene, camera); // Force a refresh
        };

        window.reset3DView = function () {
            if (!camera || !controls || !currentData) return;
            
            // Recalculate optimal distance based on current geometry
            const I = currentData.inputs;
            const anchors = currentData.anchors || [];
            let maxAnchorX = 0, maxAnchorY = 0;

            if (anchors.length > 0) {
                maxAnchorX = Math.max(...anchors.map(a => a.x));
                maxAnchorY = Math.max(...anchors.map(a => a.y));
            }

            const slabW = maxAnchorX + I.ca2 * 2 + 10; 
            const slabH = maxAnchorY + I.ca1 * 2 + 10;
            
            // Determine distance to fit the slab
            const maxDim = Math.max(slabW, slabH, I.ha);
            const distance = maxDim * 2; // Multiplier to ensure it fits in frame

            // Reset Camera and Controls
            controls.reset(); // Stop auto-rotation or inertia
            camera.position.set(distance, distance, distance);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);
            
            controls.update();
            renderer.render(scene, camera);
        };
        
        window.performCalculation = function () {
            const val = (id) => parseFloat(document.getElementById(id).value) || 0;
            const str = (id) => document.getElementById(id).value;
            const chk = (id) => document.getElementById(id).checked;
            
            const I = {
                fc: val('fc'), ha: val('ha'), da: val('da'), hef: val('hef'), s1: val('s1'), s2: val('s2'),
                ca1: val('ca1'), ca1_1: val('ca1_1'), ca2: val('ca2'), T: val('loadT'), V: val('loadV'),
                kc: parseFloat(str('kc_select')), lambda: parseFloat(str('lambda_select')), le_mode: str('le_select'), psi_c_V: parseFloat(str('psi_c_V_select')),
                e_prime_n: val('e_prime_n'), e_prime_v: val('e_prime_v'),
                // Steel inputs
                futa: val('futa'), fya: val('fya'), ase: val('ase'), is_grouted: chk('is_grouted'),
                // Step 2 Inputs
                pull_mode: str('pullout_mode'), abrg: val('abrg'), eh: val('eh'), np_cert: val('np_certified'), psi_c_P: parseFloat(str('crack_cond_p')),
                // Step 3 Inputs
                is_adhesive: chk('is_adhesive'), tau: val('tau'),
                // Step 4 Inputs
                cond_ab: str('condition_ab'), category: parseFloat(str('anchor_category')), ductility: str('steel_ductility'),
                // Step 6 Inputs
                is_seismic: chk('is_seismic'), loadT_sust: val('loadT_sust'),
                // Step 8 Input
                cac: val('cac'),
                // NEW Step 11: Shear Direction
                v_dir: str('shear_dir'),
                // NEW Features Inputs
                is_shearlug: chk('is_shearlug'), sl_h: val('sl_h'), sl_w: val('sl_w'), sl_t: val('sl_t'), sl_c: val('sl_c'),
                is_reinf: chk('is_reinf'), reinf_area: val('reinf_area'), reinf_fy: val('reinf_fy'),
                stretch_len: val('stretch_len'), kc_raw: str('kc_select'),
                layout_mode: str('layout_mode'),
                custom_coords: str('custom_coords')
            };

            const warnings = [];
            // --- STEP 10: Dynamic Anchor Array ---
            let anchors = [];
            const lMode = I.layout_mode;
            if (lMode === 'grid') {
                anchors.push({ x: I.ca2, y: I.ca1 });
                if (I.s2 > 0) anchors.push({ x: I.ca2 + I.s2, y: I.ca1 });
                if (I.s1 > 0) anchors.push({ x: I.ca2, y: I.ca1 + I.s1 });
                if (I.s1 > 0 && I.s2 > 0) anchors.push({ x: I.ca2 + I.s2, y: I.ca1 + I.s1 });
            } else {
                const raw = I.custom_coords.trim();

                if (!raw) {
                    // UPDATE: Translation for empty warning
                    const wMsg = translations[currentLang]['warn_custom_empty'] || "Custom coordinates empty. Using default 2x2 grid.";
                    warnings.push(wMsg);
                    anchors = [
                        { x: I.ca2, y: I.ca1 },
                        { x: I.ca2 + I.s2, y: I.ca1 },
                        { x: I.ca2, y: I.ca1 + I.s1 },
                        { x: I.ca2 + I.s2, y: I.ca1 + I.s1 }
                    ];
                } else {
                    anchors = raw.split(';').map(pair => {
                        const parts = pair.trim().split(',');
                        const x = parseFloat(parts[0]);
                        const y = parseFloat(parts[1]);

                        if (isNaN(x) || isNaN(y)) {
                            warnings.push(`Invalid coordinate: "${pair.trim()}" (non-numeric)`);
                            return null;
                        }
                        if (x < 0 || y < 0) {
                            warnings.push(`Negative coordinate rejected: (${x.toFixed(1)}, ${y.toFixed(1)})`);
                            return null;
                        }
                        return { x, y };
                    }).filter(a => a !== null);

                    if (anchors.length === 0) {
                        warnings.push("All custom coordinates invalid. Using default 2x2 grid.");
                        anchors = [
                            { x: I.ca2, y: I.ca1 },
                            { x: I.ca2 + I.s2, y: I.ca1 },
                            { x: I.ca2, y: I.ca1 + I.s1 },
                            { x: I.ca2 + I.s2, y: I.ca1 + I.s1 }
                        ];
                    }
                }

                // Auto-calculate S1, S2, Ca1, Ca2 from custom anchors
                if (anchors.length >= 2) {
                    const xs = anchors.map(a => a.x).sort((a, b) => a - b);
                    const ys = anchors.map(a => a.y).sort((a, b) => a - b);

                    I.ca2 = xs[0]; // Leftmost anchor = ca2
                    I.ca1 = ys[0]; // Topmost anchor = ca1

                    // Find smallest non-zero spacing in X direction
                    let minSpacingX = Infinity;
                    for (let i = 1; i < xs.length; i++) {
                        const diff = xs[i] - xs[i - 1];
                        if (diff > 0.1 && diff < minSpacingX) minSpacingX = diff;
                    }
                    I.s2 = minSpacingX === Infinity ? 0 : minSpacingX;

                    // Find smallest non-zero spacing in Y direction
                    let minSpacingY = Infinity;
                    for (let i = 1; i < ys.length; i++) {
                        const diff = ys[i] - ys[i - 1];
                        if (diff > 0.1 && diff < minSpacingY) minSpacingY = diff;
                    }
                    I.s1 = minSpacingY === Infinity ? 0 : minSpacingY;
                }
            }

            // Re-calculate eccentricities based on centroid of the custom group
            const sumX = anchors.reduce((s, a) => s + a.x, 0);
            const sumY = anchors.reduce((s, a) => s + a.y, 0);
            const centroid = { x: sumX / anchors.length, y: sumY / anchors.length };

            // --- LOGIC UPDATE: Concrete Limits ---
            let fc_calc = I.fc;
            if (I.kc_raw === '10' && I.fc > 700) { // Cast-in
                fc_calc = 700;
                warnings.push(`Concrete Strength capped at 700 kgf/cm² (Cast-in limit).`);
            } else if ((I.kc_raw === '7' || I.kc_raw === 'screw') && I.fc > 560) { // Post-installed / Screw
                fc_calc = 560;
                warnings.push(`Concrete Strength capped at 560 kgf/cm² (Post-installed limit).`);
            }
            I.fc = fc_calc; // Use capped value for calcs

            // --- LOGIC UPDATE: Seismic Detailing ---
            if (I.is_seismic && I.ductility === 'ductile') {
                if (I.stretch_len < 8 * I.da) {
                    warnings.push(`Seismic Violation: Stretch Length (${I.stretch_len}) < 8da (${(8*I.da).toFixed(2)}).`);
                }
            }

            // --- STEP 7: Minimum Geometry Validation ---
            const min_s = 6 * I.da; 
            const min_c = 6 * I.da; 

            if (I.s1 > 0 && I.s1 < min_s) warnings.push(`Vertical Spacing (S1): ${I.s1} < ${min_s.toFixed(2)} cm (6da)`);
            if (I.s2 > 0 && I.s2 < min_s) warnings.push(`Horizontal Spacing (S2): ${I.s2} < ${min_s.toFixed(2)} cm (6da)`);
            if (I.ca1 < min_c) warnings.push(`Top Edge (Ca1): ${I.ca1} < ${min_c.toFixed(2)} cm (6da)`);
            if (I.ca1_1 < min_c) warnings.push(`Bottom Edge (Ca1,1): ${I.ca1_1} < ${min_c.toFixed(2)} cm (6da)`);
            if (I.ca2 < min_c) warnings.push(`Side Edge (Ca2): ${I.ca2} < ${min_c.toFixed(2)} cm (6da)`);
            
            // ------------------------------------------

            // --- Determine Factors ---
            const isDuctile = I.ductility === 'ductile';
            const isCondA = I.cond_ab === 'A';
            const isCastIn = I.kc >= 10; 
            const cat = I.category;

            // 1. Steel Phi
            const phi_st = isDuctile ? 0.75 : 0.65;
            const phi_sv = isDuctile ? 0.65 : 0.60;

            // 2. Concrete Breakout / Bond Phi
            let phi_c = 0.70; 
            if (isCondA) { 
                if (isCastIn) phi_c = 0.75;
                else {
                    if (cat === 1) phi_c = 0.75;
                    else if (cat === 2) phi_c = 0.65;
                    else phi_c = 0.55;
                }
            } else { 
                if (isCastIn) phi_c = 0.70;
                else {
                    if (cat === 1) phi_c = 0.65;
                    else if (cat === 2) phi_c = 0.55;
                    else phi_c = 0.45;
                }
            }
            
            // 3. Pullout / Pryout Phi
            let phi_p = 0.70;
            if (isCastIn) {
                phi_p = 0.70;
            } else {
                if (cat === 1) phi_p = 0.65;
                else if (cat === 2) phi_p = 0.55;
                else phi_p = 0.45;
            }
            
            const phi_bond = phi_c; 
            const phi_reinf = 0.75; // Reinforcement Phi

            // --- SEISMIC REDUCTION FACTORS ---
            const seis_conc = I.is_seismic ? 0.75 : 1.0;
            const seis_pull = I.is_seismic ? 0.75 : 1.0;
            let seis_bond = 1.0;
            if (I.is_seismic) {
                seis_bond = (I.psi_c_P > 1.0) ? 0.4 : 0.8;
            }

            // -------------------------------------

            let le_val = 12.7; if (I.le_mode === 'sleeve') le_val = I.hef; else if (I.le_mode === 'torque') le_val = 2 * I.da;
            const ca_min = Math.min(I.ca1, I.ca1_1, I.ca2);
            let psi_ed_N = (ca_min < 1.5 * I.hef) ? (0.7 + 0.3 * (ca_min / (1.5 * I.hef))) : 1.0;
            let psi_ed_V = (I.ca2 < 1.5 * I.ca1_1) ? (0.7 + 0.3 * (I.ca2 / (1.5 * I.ca1_1))) : 1.0;
            let psi_ec_N = 1.0; if (I.e_prime_n > 0) psi_ec_N = 1.0 / (1.0 + (2.0 * I.e_prime_n) / (3.0 * I.hef));
            let psi_ec_V = 1.0; if (I.e_prime_v > 0) psi_ec_V = 1.0 / (1.0 + (2.0 * I.e_prime_v) / (3.0 * I.ca1_1));

            // Step 8: Splitting Factor (psi_cp_N)
            let psi_cp_N = 1.0;
            const isUncracked = I.psi_c_V >= 1.4;
            const isPost = I.kc < 10; // 7 is post or screw
            if (isPost && isUncracked) {
                if (ca_min < I.cac) {
                    // PDF Eq 17.6.2.6.1b: Max of (ca_min/cac) and (1.5hef/cac)
                    psi_cp_N = Math.max(ca_min / I.cac, (1.5 * I.hef) / I.cac);
                }
            }

            // --- STEP 1: Steel Strength Logic ---
            const futa_limit = Math.min(1.9 * I.fya, 8750);
            const futa_eff = Math.min(I.futa, futa_limit);
            const Nsa = I.ase * futa_eff;
            const phi_Nsa = phi_st * Nsa; 
            const ratio_st = I.T > 0 ? (I.T / phi_Nsa) : 0;

            let Vsa_coeff = 0.6; 
            let Vsa = Vsa_coeff * I.ase * futa_eff;
            if (I.is_grouted) Vsa *= 0.8;
            const phi_Vsa = phi_sv * Vsa; 
            const ratio_sv = I.V > 0 ? (I.V / phi_Vsa) : 0;

            // --- Breakout Logic ---
            const Nb = I.kc * I.lambda * Math.sqrt(I.fc) * Math.pow(I.hef, 1.5);
            const Anco = 9 * Math.pow(I.hef, 2);
            const Anc_1 = 2 * (1.5 * I.hef) * (I.ca1 + I.s1 + 1.5 * I.hef);
            
            // Logic Update: Anchor Reinforcement Replacement (Tension)
            const phi_Ncb_concrete = seis_conc * phi_c * (Anc_1 / Anco) * psi_ed_N * 1.0 * psi_cp_N * Nb;

            let phi_Ncb_final = phi_Ncb_concrete;
            let N_reinf_cap = 0;

            if (I.is_reinf && I.reinf_area > 0) {
                N_reinf_cap = I.reinf_area * I.reinf_fy;
                const phi_Nreinf = phi_reinf * N_reinf_cap;
                // Take MINIMUM (governing failure mode)
                phi_Ncb_final = Math.min(phi_Ncb_concrete, phi_Nreinf);
            }
            const ratio_1 = I.T > 0 ? (I.T / phi_Ncb_final) : 0;

			// Helper for Shear Breakout
			const calcShearBreakout = (edgeDist) => {
				const Vb1_local = 1.86 * Math.pow(le_val / I.da, 0.2) * Math.sqrt(I.da) * I.lambda * Math.sqrt(I.fc) * Math.pow(edgeDist, 1.5);
				const Vb2_local = 3.8 * I.lambda * Math.sqrt(I.fc) * Math.pow(edgeDist, 1.5);
				const Vb_local = Math.min(Vb1_local, Vb2_local);
				const Avco_local = 4.5 * Math.pow(edgeDist, 2);
				const Avc_local = 2 * (1.5 * edgeDist) * I.ha;
				let orthEdge = (edgeDist === I.ca1_1) ? I.ca2 : I.ca1_1;
				let psi_ed_V_local = (orthEdge < 1.5 * edgeDist) ? (0.7 + 0.3 * (orthEdge / (1.5 * edgeDist))) : 1.0;
				let psi_h_V_local = Math.pow((1.5 * edgeDist) / I.ha, 0.5);
				if (psi_h_V_local < 1.0) psi_h_V_local = 1.0;
				
				return { 
					cap: seis_conc * phi_c * (Avc_local / Avco_local) * psi_ed_V_local * I.psi_c_V * psi_h_V_local * Vb_local,
					vb: Vb_local,
					avc: Avc_local,
					avco: Avco_local,
					psih: psi_h_V_local
				};
			};

			// Logic Update: Corner Shear Analysis
			let phi_Vcb_final = 0;
            // Determine critical edge distance based on shear direction
            let critical_shear_edge = I.ca1_1; // Default: perpendicular (front edge)
            const shear_para_factor = (I.v_dir === 'para') ? 2.0 : 1.0;

            // Then use critical_shear_edge in calcShearBreakout
            let shear_result = calcShearBreakout(critical_shear_edge);

            // Logic Update: Corner Shear Analysis
            let phi_Vcb_governing = 0;
            const res_front = calcShearBreakout(I.ca1_1); // Standard Perp (Front Edge)
            
            // Populate display data with standard perp values by default
            let Vb = res_front.vb;
            let Avc_2 = res_front.avc;
            let Avco = res_front.avco;
            let psi_h_V = res_front.psih;

            if (I.v_dir === 'para') {
                // Parallel Mode: Check 2 failure modes (PDF 17.7.2.1)
                
                // Mode A: Shear towards Side Edge (Perpendicular failure of side edge)
                const res_side = calcShearBreakout(I.ca2);
                const Vcb_side = res_side.cap;

                // Mode B: Shear Parallel to Front Edge (2x factor, psi_ed = 1.0)
                // Recalculate Front capacity with psi_ed_V forced to 1.0 and 2.0 multiplier
                const cap_para_front = seis_conc * phi_c * (res_front.avc / res_front.avco) * 1.0 * I.psi_c_V * res_front.psih * (2.0 * res_front.vb);

                // Governing is the minimum of Side-Perp and Front-Parallel
                phi_Vcb_governing = Math.min(Vcb_side, cap_para_front);

                // Update display data to show the governing mode's values
                if (Vcb_side < cap_para_front) {
                    Vb = res_side.vb; Avc_2 = res_side.avc; Avco = res_side.avco; psi_h_V = res_side.psih;
                }
            } else {
                // Perpendicular Mode: Check Front and Corner effects
                const res_corner = calcShearBreakout(I.ca2);
                phi_Vcb_governing = Math.min(res_front.cap, res_corner.cap);
                // (Display data remains as Front Edge default)
            }

            // Logic Update: Anchor Reinforcement Replacement (Shear)
            const phi_Vcb_concrete = phi_Vcb_governing;

            phi_Vcb_final = phi_Vcb_concrete;
            let V_reinf_cap = 0;

            if (I.is_reinf && I.reinf_area > 0) {
                V_reinf_cap = I.reinf_area * I.reinf_fy;
                const phi_Vreinf = phi_reinf * V_reinf_cap;
                // Take MINIMUM (governing failure mode)
                phi_Vcb_final = Math.min(phi_Vcb_concrete, phi_Vreinf);
            }
			const ratio_2 = I.V > 0 ? (I.V / phi_Vcb_final) : 0;

            // Group Calcs (Simplified, not applying corner logic here for brevity as instructed "min lines")
            // Calculate actual group area based on anchor positions
            const xs = anchors.map(a => a.x);
            const ys = anchors.map(a => a.y);
            const minX = Math.min(...xs);
            const maxX = Math.max(...xs);
            const minY = Math.min(...ys);
            const maxY = Math.max(...ys);

            // Group area considers all anchors' projection
            const groupWidth = (maxX - minX) + 2 * (1.5 * I.hef);
            const groupHeight = (maxY - minY) + 2 * (1.5 * I.hef);
            const Anc_3 = groupWidth * groupHeight;
            let phi_Ncbg = seis_conc * phi_c * (Anc_3 / Anco) * psi_ec_N * psi_ed_N * 1.0 * psi_cp_N * Nb;
            if (I.is_reinf) phi_Ncbg = phi_Ncb_final * anchors.length; // Reinforcement scales with # of anchors
            const ratio_3 = I.T > 0 ? (I.T / phi_Ncbg) : 0;  // Total load = per-anchor load × count

            // Group shear area based on actual layout
            const Avc_4 = ((maxX - minX) + 2 * (1.5 * I.ca1_1)) * I.ha;
            const Vb_basic = Math.min(
                1.86 * Math.pow(le_val / I.da, 0.2) * Math.sqrt(I.da) * I.lambda * Math.sqrt(I.fc) * Math.pow(I.ca1_1, 1.5),
                3.8 * I.lambda * Math.sqrt(I.fc) * Math.pow(I.ca1_1, 1.5)
            );
            const Avco_basic = 4.5 * Math.pow(I.ca1_1, 2);
            let phi_Vcbg = shear_para_factor * seis_conc * phi_c * (Avc_4 / Avco_basic) * psi_ec_V * psi_ed_V * I.psi_c_V * 1.0 * Vb_basic;
            if (I.is_reinf) phi_Vcbg = phi_Vcb_final * anchors.length;
            const ratio_4 = I.V > 0 ? (I.V / phi_Vcbg) : 0; // Total load scales with anchors

            // --- STEP 2: Pullout & Pryout Logic ---
            let Np = 0;
            if (I.pull_mode === 'headed') {
                Np = 8 * I.abrg * I.fc;
            } else if (I.pull_mode === 'hooked') {
                Np = 0.9 * I.fc * I.eh * I.da;
            } else {
                Np = I.np_cert;
            }
            const Npn = Np * I.psi_c_P;
            const phi_Npn = seis_pull * phi_p * Npn; 
            const ratio_pn = I.T > 0 ? (I.T / phi_Npn) : 0;

            const kcp = (I.hef >= 6.35) ? 2.0 : 1.0; 
            // Nominal Breakout Ncp (approximate reverse calc)
            const N_breakout_nominal = Math.min(phi_Ncb_final / (phi_c * seis_conc), phi_Ncbg / (phi_c * seis_conc)); 
            
            // NEW Step 9: Adhesive Pryout Refinement
            let Ncp = N_breakout_nominal;
            let bond_res = { nba: 0, cna: 0, na: 0, cap: 0, ratio: 0, ok: true, sust_ok: true, sust_cap: 0, na_nominal: 999999999 };

            if (I.is_adhesive) {
                const cNa = 10 * I.da * Math.sqrt(I.tau / 77.0);
                const ANao = Math.pow(2 * cNa, 2);
                const ANa_val = (cNa + Math.min(cNa, I.ca1)) * (cNa + Math.min(cNa, I.ca2));
                const ca_min_bond = Math.min(I.ca1, I.ca2);
                const psi_ed_Na = (ca_min_bond < cNa) ? (0.7 + 0.3 * (ca_min_bond / cNa)) : 1.0;
                let psi_cp_Na = 1.0;
                if (isUncracked && ca_min < I.cac) psi_cp_Na = ca_min / I.cac;

                const Nba = I.lambda * I.tau * Math.PI * I.da * I.hef;
                const Na = (ANa_val / ANao) * psi_ed_Na * psi_cp_Na * Nba;
                const phi_Na = seis_bond * phi_bond * Na; 
                const ratio_b = I.T > 0 ? (I.T / phi_Na) : 0;
                const sust_cap = 0.4 * phi_bond * Na; 
                const sust_ok = I.loadT_sust <= sust_cap;
                bond_res = { nba: Nba, cna: cNa, na: Na, cap: phi_Na, ratio: ratio_b, ok: ratio_b < 1.0, sust_ok: sust_ok, sust_cap: sust_cap, na_nominal: Na };

                Ncp = Math.min(N_breakout_nominal, bond_res.na_nominal);
            }

            const Vcp = kcp * Ncp;
            const phi_Vcp = seis_conc * phi_p * Vcp; 
            const ratio_cp = I.V > 0 ? (I.V / phi_Vcp) : 0;

            // --- STEP 5: Side-Face Blowout (Nsb) ---
            let Nsb = 0;
            let phi_Nsb = 0;
            let ratio_sb = 0;
            let sb_applicable = false;
            if (I.pull_mode === 'headed' && I.hef > 2.5 * I.ca1) {
                sb_applicable = true;
                Nsb = 42.4 * I.ca1 * Math.sqrt(I.abrg) * I.lambda * Math.sqrt(I.fc);
                if (I.s2 > 0 && I.s2 < 6 * I.ca1) {
                    Nsb = Nsb * (1 + I.s2 / (6 * I.ca1));
                }
                phi_Nsb = seis_conc * phi_c * Nsb; 
                ratio_sb = I.T > 0 ? (I.T / phi_Nsb) : 0;
            }

            // --- NEW FEATURE: Shear Lug Analysis ---
            let sl_res = { vbrg: 0, vcbsl: 0, cap: 0, ratio: 0, applicable: false };
            if (I.is_shearlug) {
                sl_res.applicable = true;
                // Bearing Strength
                // Aef_sl approx Wsl * hsl
                const Aef_sl = I.sl_w * I.sl_h;
                const phi_brg = 0.65; // Bearing phi
                const Vbrg = phi_brg * 1.7 * I.fc * Aef_sl;

                // Concrete Breakout for Shear Lug
                // Uses c_sl instead of ca1
                const c_sl = I.sl_c;
                const Avc_sl = (2 * 1.5 * c_sl + I.sl_w) * I.ha; // Approx projected area for lug
                const Avco_sl = 4.5 * Math.pow(c_sl, 2);
                const Vb_sl = 3.8 * I.lambda * Math.sqrt(I.fc) * Math.pow(c_sl, 1.5); // Simplified Vb eq
                const phi_Vcbsl = phi_c * (Avc_sl / Avco_sl) * 1.0 * 1.0 * 1.0 * Vb_sl;

                sl_res.vbrg = Vbrg;
                sl_res.vcbsl = phi_Vcbsl;
                sl_res.cap = Math.min(Vbrg, phi_Vcbsl);
                sl_res.ratio = I.V > 0 ? (I.V / sl_res.cap) : 0;
            }

            // --- STEP 4: Interaction Check (ACI Trilinear) ---
            let ratios_N = [ratio_st, ratio_1, ratio_3, ratio_pn];
            if (I.is_adhesive) ratios_N.push(bond_res.ratio);
            if (sb_applicable) ratios_N.push(ratio_sb); 
            const max_N = Math.max(...ratios_N);

            let ratios_V = [ratio_sv, ratio_2, ratio_4, ratio_cp];
            if (sl_res.applicable) ratios_V.push(sl_res.ratio);
            const max_V = Math.max(...ratios_V);

            let int_check = "OK";
            let int_val = max_N + max_V;
            
            // Trilinear Interaction Logic
            if (max_N <= 0.2 && max_V <= 1.0) {
                int_check = "OK (N≤0.2)";
            } else if (max_V <= 0.2 && max_N <= 1.0) {
                int_check = "OK (V≤0.2)";
            } else {
                if (int_val > 1.2) int_check = "FAIL";
                else int_check = "OK";
            }

            currentData = {
                inputs: I, anchors: anchors, factors: { psi_ed_N, psi_ed_V, psi_ec_N, psi_ec_V, psi_cp_N }, calcs: { 
                    s1: { nsa: Nsa, cap: phi_Nsa, load: I.T, ratio: ratio_st, ok: ratio_st < 1.0 },
                    s2: { vsa: Vsa, cap: phi_Vsa, load: I.V, ratio: ratio_sv, ok: ratio_sv < 1.0 },
                    pn: { np: Np, npn: Npn, cap: phi_Npn, load: I.T, ratio: ratio_pn, ok: ratio_pn < 1.0 }, 
                    cp: { vcp: Vcp, cap: phi_Vcp, load: I.V, ratio: ratio_cp, ok: ratio_cp < 1.0 },
                    bond: bond_res,
                    sb: { nsb: Nsb, cap: phi_Nsb, ratio: ratio_sb, ok: ratio_sb < 1.0, applicable: sb_applicable }, 
                    sl: sl_res, // Shear Lug
                    c1: { nb: Nb, anc: Anc_1, anco: Anco, cap: phi_Ncb_final, load: I.T, ratio: ratio_1, ok: ratio_1 < 1.0, is_reinf: I.is_reinf },
                    c2: { vb: Vb, avc: Avc_2, avco: Avco, cap: phi_Vcb_final, load: I.V, ratio: ratio_2, psih: psi_h_V, ok: ratio_2 < 1.0, is_reinf: I.is_reinf },
                    c3: { anc: Anc_3, cap: phi_Ncbg, load: I.T, ratio: ratio_3, ok: ratio_3 < 1.0 },
                    c4: { avc: Avc_4, cap: phi_Vcbg, load: I.V, ratio: ratio_4, psih: psi_h_V, ok: ratio_4 < 1.0 },
                    interaction: { max_n: max_N, max_v: max_V, val: int_val, status: int_check },
                    geo_warnings: warnings 
                }, timestamp: new Date()
            };

            if (renderer && currentVizMode === '3d') {
                update3DScene(anchors, I);
            }

            updateUI();
        };

        function updateUI() {
            if (!currentData) return;
            const d = currentData.calcs; const f = currentData.factors;
            const I = currentData.inputs;
            document.getElementById('results-container').classList.remove('hidden');
            const set = (id, val, unit = '') => document.getElementById(id).innerText = Math.round(val) + unit;

            // Step 7: Warning Display
            const warnBox = document.getElementById('geo-warn-box');
            const warnList = document.getElementById('geo-warn-list');
            if (d.geo_warnings.length > 0) {
                warnBox.classList.remove('hidden');
                warnList.innerHTML = d.geo_warnings.map(w => `<li>${w}</li>`).join('');
            } else {
                warnBox.classList.add('hidden');
            }

            const showTension = I.T > 0;
            const showShear = I.V > 0;

            document.getElementById('card-tension').classList.toggle('hidden', !showTension);
            document.getElementById('card-shear').classList.toggle('hidden', !showShear);
            document.getElementById('card-steel').classList.toggle('hidden', !(showTension || showShear));
            document.getElementById('card-pullout').classList.toggle('hidden', !(showTension || showShear));
            document.getElementById('card-bond').classList.toggle('hidden', !(showTension && I.is_adhesive));
            document.getElementById('card-interaction').classList.toggle('hidden', !(showTension || showShear));

            // Toggle visibility based on selected mode
            document.getElementById('card-viz').style.display = (currentVizMode === '2d') ? 'block' : 'none';
            document.getElementById('card-3d').style.display = (currentVizMode === '3d') ? 'block' : 'none';

            // Seismic Badge Display Logic
            const seisDisplay = I.is_seismic ? 'inline' : 'none';
            document.getElementById('badge-seis-t').style.display = seisDisplay;
            document.getElementById('badge-seis-v').style.display = seisDisplay;
            document.getElementById('badge-seis-pull').style.display = seisDisplay;
            document.getElementById('badge-seis-bond').style.display = seisDisplay;

            if (showTension || showShear) {
                set('r-nsa', d.s1.nsa, ' kgf'); set('r-phi-nsa', d.s1.cap, ' kgf');
                document.getElementById('r-st-ratio').innerText = (d.s1.ratio || 0).toFixed(2);
                setStatus('badge-st', d.s1.ok);

                set('r-vsa', d.s2.vsa, ' kgf'); set('r-phi-vsa', d.s2.cap, ' kgf');
                document.getElementById('r-sv-ratio').innerText = (d.s2.ratio || 0).toFixed(2);
                setStatus('badge-sv', d.s2.ok);

                set('r-npn', d.pn.npn, ' kgf'); set('r-phi-npn', d.pn.cap, ' kgf');
                document.getElementById('r-pn-ratio').innerText = (d.pn.ratio || 0).toFixed(2);
                setStatus('badge-pn', d.pn.ok);

                set('r-vcp', d.cp.vcp, ' kgf'); set('r-phi-vcp', d.cp.cap, ' kgf');
                document.getElementById('r-cp-ratio').innerText = (d.cp.ratio || 0).toFixed(2);
                setStatus('badge-cp', d.cp.ok);

                // Interaction UI
                document.getElementById('val-max-n').innerText = d.interaction.max_n.toFixed(2);
                document.getElementById('val-max-v').innerText = d.interaction.max_v.toFixed(2);
                document.getElementById('val-int-sum').innerText = d.interaction.val.toFixed(2);
                const badgeInt = document.getElementById('badge-int');
                badgeInt.innerText = d.interaction.status;
                if (d.interaction.status === 'OK' || d.interaction.status.includes('N/A')) {
                    badgeInt.className = "px-4 py-2 rounded font-bold text-center bg-green-600";
                } else {
                    badgeInt.className = "px-4 py-2 rounded font-bold text-center bg-red-600 animate-pulse";
                }
            }

            if (showTension && I.is_adhesive) {
                set('r-nba', d.bond.nba, ' kgf');
                set('r-cna', d.bond.cna, ' cm');
                set('r-na', d.bond.na, ' kgf'); 
                set('r-phi-na', d.bond.cap, ' kgf');
                document.getElementById('r-b-ratio').innerText = (d.bond.ratio || 0).toFixed(2);
                setStatus('badge-b', d.bond.ok);

                // Sustained Row
                document.getElementById('row-sust').classList.remove('hidden');
                set('r-sust-load', I.loadT_sust, ' kgf');
                const badgeSust = document.getElementById('badge-sust');
                if (d.bond.sust_ok) {
                    badgeSust.innerText = "PASS";
                    badgeSust.className = "text-xs px-2 py-0.5 rounded font-bold bg-green-100 text-green-800 border border-green-200";
                } else {
                    badgeSust.innerText = "FAIL";
                    badgeSust.className = "text-xs px-2 py-0.5 rounded font-bold bg-red-100 text-red-800 border border-red-200";
                }
            } else {
                document.getElementById('row-sust').classList.add('hidden');
            }

            if (showTension) {
                set('r1-nb', d.c1.nb, ' kgf'); set('r1-anc', d.c1.anc, ' cm²'); set('r1-cap', d.c1.cap, ' kgf');
                document.getElementById('r1-ratio').innerText = (d.c1.ratio || 0).toFixed(2);
                setStatus('badge-1', d.c1.ok);
                document.getElementById('r1-psi-cp').innerText = f.psi_cp_N.toFixed(2);

                set('r3-anc', d.c3.anc, ' cm²'); set('r3-cap', d.c3.cap, ' kgf'); set('r3-psi', f.psi_ec_N.toFixed(2));
                document.getElementById('r3-ratio').innerText = (d.c3.ratio || 0).toFixed(2);
                setStatus('badge-3', d.c3.ok);

                const rowSb = document.getElementById('row-sb');
                if (d.sb.applicable) {
                    rowSb.classList.remove('hidden');
                    set('r-nsb', d.sb.nsb, ' kgf');
                    set('r-phi-nsb', d.sb.cap, ' kgf');
                    document.getElementById('r-sb-ratio').innerText = (d.sb.ratio || 0).toFixed(2);
                    setStatus('badge-sb', d.sb.ok);
                } else {
                    rowSb.classList.add('hidden');
                }
            }

            if (showShear) {
                set('r2-vb', d.c2.vb, ' kgf'); set('r2-avc', d.c2.avc, ' cm²'); set('r2-cap', d.c2.cap, ' kgf');
                document.getElementById('r2-ratio').innerText = (d.c2.ratio || 0).toFixed(2);
                setStatus('badge-2', d.c2.ok);

                set('r4-avc', d.c4.avc, ' cm²'); set('r4-cap', d.c4.cap, ' kgf'); set('r4-psi', f.psi_ec_V.toFixed(2));
                document.getElementById('r4-ratio').innerText = (d.c4.ratio || 0).toFixed(2);
                setStatus('badge-4', d.c4.ok);

                // Shear Lug Row
                const rowSl = document.getElementById('row-sl');
                if (d.sl.applicable) {
                    rowSl.classList.remove('hidden');
                    set('r-vbrg', d.sl.vbrg, ' kgf');
                    set('r-vcbsl', d.sl.vcbsl, ' kgf');
                    set('r-sl-cap', d.sl.cap, ' kgf');
                    setStatus('badge-sl', d.sl.ratio < 1.0);
                } else {
                    rowSl.classList.add('hidden');
                }
            }

            // --- Step 7: Draw Visualization ---
            drawVisualization();

            // Force 3D refresh when in 3D mode
            if (currentVizMode === '3d' && currentData.anchors && renderer) {
                update3DScene(currentData.anchors, currentData.inputs);
                renderer.render(scene, camera);
            }
        }

        // NEW Step 7: Visualization Function
        function drawVisualization() {
            const canvas = document.getElementById('viz-canvas');
            if (!canvas || !currentData) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const I = currentData.inputs;
            const min_s = 6 * I.da;
            const min_c = 6 * I.da;

            // Clear
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#f8fafc'; // bg-slate-50
            ctx.fillRect(0, 0, w, h);

            // Scale logic: We need to fit (ca2 + s2 + margin) width and (ca1 + s1 + margin) height
            // Assume concrete extends slightly beyond anchors.
            // Coordinates: (0,0) is top-left of canvas.
            // Edge Top (ca1) is Y axis. Edge Left (ca2) is X axis.
            
            // Determine logical bounding box
            // Determine logical bounding box based on actual anchor positions
            const anchors = currentData.anchors || [];
            let maxAnchorX = 0;
            let maxAnchorY = 0;

            if (anchors.length > 0) {
                maxAnchorX = Math.max(...anchors.map(a => a.x));
                maxAnchorY = Math.max(...anchors.map(a => a.y));
            }

            // Calculate concrete dimensions to cover all anchors plus edge distances
            const totalWidth = maxAnchorX + I.ca2 + 20; // max anchor X + right edge + margin
            const totalHeight = maxAnchorY + I.ca1 + 20; // max anchor Y + bottom edge + margin

            const padding = 40;
            const scaleX = (w - 2 * padding) / totalWidth;
            const scaleY = (h - 2 * padding) / totalHeight;
            const scale = Math.min(scaleX, scaleY);

            // Origin (Top-Left Edge Corner)
            const ox = padding;
            const oy = padding;

            // Draw Concrete Edges
            ctx.beginPath();
            ctx.strokeStyle = '#94a3b8'; // slate-400
            ctx.lineWidth = 2;
            ctx.moveTo(ox + totalWidth * scale, oy); // Right top
            ctx.lineTo(ox, oy); // Top Left (Corner)
            ctx.lineTo(ox, oy + totalHeight * scale); // Bottom Left
            ctx.stroke();

            // Draw Infinite Concrete (Dashed lines)
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.moveTo(ox + totalWidth * scale, oy);
            ctx.lineTo(ox + totalWidth * scale, oy + totalHeight * scale);
            ctx.lineTo(ox, oy + totalHeight * scale);
            ctx.stroke();
            ctx.setLineDash([]);

            // Check violations for coloring
            const bad_s1 = (I.s1 > 0 && I.s1 < min_s);
            const bad_s2 = (I.s2 > 0 && I.s2 < min_s);
            const bad_ca1 = (I.ca1 < min_c);
            const bad_ca2 = (I.ca2 < min_c);

            anchors.forEach(p => {
                const cx = ox + p.x * scale;
                const cy = oy + p.y * scale;
                const r = Math.max(I.da * scale / 2, 4); // Min 4px radius
                
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                ctx.fillStyle = '#cbd5e1'; // slate-300
                ctx.fill();
                ctx.strokeStyle = '#334155'; // slate-700
                ctx.stroke();
                
                // Crosshair center
                ctx.beginPath();
                ctx.moveTo(cx - 2, cy); ctx.lineTo(cx + 2, cy);
                ctx.moveTo(cx, cy - 2); ctx.lineTo(cx, cy + 2);
                ctx.stroke();
            });

            // Dimensions Helpers
            function drawDim(x1, y1, x2, y2, text, isBad) {
                ctx.beginPath();
                ctx.strokeStyle = isBad ? '#ef4444' : '#64748b'; // red or slate
                ctx.fillStyle = isBad ? '#ef4444' : '#64748b';
                ctx.lineWidth = 1;
                // Line
                ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
                ctx.stroke();
                // Arrows (simple dots for now)
                ctx.beginPath(); ctx.arc(x1, y1, 2, 0, 2*Math.PI); ctx.fill();
                ctx.beginPath(); ctx.arc(x2, y2, 2, 0, 2*Math.PI); ctx.fill();
                // Text
                const mx = (x1 + x2) / 2;
                const my = (y1 + y2) / 2;
                ctx.font = isBad ? "bold 12px sans-serif" : "12px sans-serif";
                ctx.fillText(text, mx + 5, my - 5);
            }

            // Draw Ca1
            const ax = ox + I.ca2 * scale; 
            drawDim(ax, oy, ax, oy + I.ca1 * scale, `Ca1=${I.ca1} cm`, bad_ca1);

            // Draw Ca2
            const ay = oy + I.ca1 * scale;
            drawDim(ox, ay, ox + I.ca2 * scale, ay, `Ca2=${I.ca2} cm`, bad_ca2);

            // Draw S1 (if exists)
            if (I.s1 > 0) {
                const sx = ox + I.ca2 * scale + 20; // Offset slightly
                drawDim(sx, ay, sx, ay + I.s1 * scale, `s1=${I.s1} cm`, bad_s1);
            }

            // Draw S2 (if exists)
            if (I.s2 > 0) {
                const sy = oy + I.ca1 * scale + 20;
                drawDim(ax, sy, ax + I.s2 * scale, sy, `s2=${I.s2} cm`, bad_s2);
            }
        }

        function setStatus(id, isOk) {
            const el = document.getElementById(id);
            if (isOk) { el.innerText = t('pass'); el.className = "text-xs px-2 py-0.5 rounded font-bold bg-green-100 text-green-800 border border-green-200"; }
            else { el.innerText = t('fail'); el.className = "text-xs px-2 py-0.5 rounded font-bold bg-red-100 text-red-800 border border-red-200"; }
        }

        window.saveResult = async function () {
            if (!currentUser) { alert("Please login first."); return; }
            const btn = document.getElementById('save-btn'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>' + (currentLang === 'en' ? 'Saving...' : '儲存中...');
            performCalculation(); if (!currentData) return;
            try {
                await db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').add({
                    inputs: currentData.inputs, summary: { ratio1: currentData.calcs.c1.ratio, ratio2: currentData.calcs.c2.ratio, ratio3: currentData.calcs.c3.ratio, ratio4: currentData.calcs.c4.ratio, allPass: currentData.calcs.c1.ok && currentData.calcs.c2.ok && currentData.calcs.c3.ok && currentData.calcs.c4.ok && currentData.calcs.s1.ok && currentData.calcs.s2.ok && currentData.calcs.pn.ok && currentData.calcs.cp.ok },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saved!'; setTimeout(() => btn.innerHTML = `<i class="fa-solid fa-cloud-arrow-up mr-2"></i>${t('btn_save')}`, 2000);
            } catch (e) { console.error(e); btn.innerHTML = 'Error'; }
        };

        window.clearHistory = async function () {
            if (!currentUser) return; if (!confirm("Are you sure?")) return;
            const list = document.getElementById('history-list'); list.innerHTML = '<div class="p-6 text-center text-red-500"><i class="fa-solid fa-trash fa-bounce mr-2"></i>Deleting...</div>';
            try {
                const snapshot = await db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').get();
                const batch = db.batch(); snapshot.docs.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); loadHistory();
            } catch (e) { console.error(e); alert("Error deleting history."); }
        };

        window.deleteHistoryItem = async function (docId, event) {
            // Prevent the parent div's click event (restore) from firing
            if (event) event.stopPropagation();

            // Use a simple confirm; though custom UI is better, this fits your current logic
            if (!confirm("Delete this record?")) return;

            try {
                await db.collection('artifacts').doc('anchor_app')
                    .collection('users').doc(currentUser.uid)
                    .collection('history').doc(docId).delete();
                // History list will auto-refresh if using onSnapshot
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };

        window.restoreFromHistory = function (docId) {
            const data = historyCache[docId]; if (!data || !data.inputs) return;
            const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
            const setChk = (id, v) => { const el = document.getElementById(id); if(el) el.checked = v; };
            
            const I = data.inputs;
            setVal('fc', I.fc); setVal('ha', I.ha); setVal('da', I.da); setVal('hef', I.hef); setVal('s1', I.s1); setVal('s2', I.s2);
            setVal('ca1', I.ca1); setVal('ca1_1', I.ca1_1); setVal('ca2', I.ca2); setVal('loadT', I.T); setVal('loadV', I.V);
            setVal('kc_select', I.kc || 10); setVal('lambda_select', I.lambda % 1 === 0 ? I.lambda.toFixed(1) : I.lambda);
            setVal('le_select', I.le_mode || 'default'); setVal('psi_c_V_select', I.psi_c_V % 1 === 0 ? I.psi_c_V.toFixed(1) : I.psi_c_V);
            setVal('e_prime_n', I.e_prime_n || 0); setVal('e_prime_v', I.e_prime_v || 0);
            
            // Restore Step 1
            if (I.futa) setVal('futa', I.futa);
            if (I.fya) setVal('fya', I.fya);
            if (I.ase) setVal('ase', I.ase);
            if (I.is_grouted !== undefined) setChk('is_grouted', I.is_grouted);

            // Restore Step 2
            if (I.pull_mode) {
                setVal('pullout_mode', I.pull_mode);
                togglePulloutInputs(); 
                setVal('abrg', I.abrg || 0);
                setVal('eh', I.eh || 0);
                setVal('np_certified', I.np_cert || 0);
                setVal('crack_cond_p', I.psi_c_P || 1.4);
            }

            // Restore Step 3
            if (I.is_adhesive !== undefined) {
                setChk('is_adhesive', I.is_adhesive);
                toggleAdhesive();
                setVal('tau', I.tau || 100);
            }

            // Restore Step 4
            if (I.cond_ab) setVal('condition_ab', I.cond_ab);
            if (I.category) setVal('anchor_category', I.category);
            if (I.ductility) setVal('steel_ductility', I.ductility);

            // Restore Step 6
            if (I.is_seismic !== undefined) setChk('is_seismic', I.is_seismic);
            if (I.loadT_sust !== undefined) setVal('loadT_sust', I.loadT_sust);

            // Restore Step 8
            if (I.cac !== undefined) setVal('cac', I.cac);

            // Restore Step 11
            if (I.v_dir) setVal('shear_dir', I.v_dir);

            // Restore Shear Lug
            if (I.is_shearlug) {
                setChk('is_shearlug', true);
                toggleShearLug();
                setVal('sl_h', I.sl_h); setVal('sl_w', I.sl_w); setVal('sl_t', I.sl_t); setVal('sl_c', I.sl_c);
            }

            // Restore Reinf
            if (I.is_reinf) {
                setChk('is_reinf', true);
                toggleReinf();
                setVal('reinf_area', I.reinf_area); setVal('reinf_fy', I.reinf_fy);
            }
            
            if (I.stretch_len) setVal('stretch_len', I.stretch_len);
            // --- RESTORE LAYOUT & ANCHORS ---
            if (I.layout_mode) {
                setVal('layout_mode', I.layout_mode);
                // Call toggleLayoutMode to show/hide the correct UI elements (Custom Coords Box vs Spacing Inputs)
                toggleLayoutMode();
            }

            if (I.custom_coords) {
                setVal('custom_coords', I.custom_coords);
                // Parse the string back into the array so the visual table can populate
                anchorData = parseCoords(); 
                // Render the table rows
                renderAnchorTable();
            } else {
                // If legacy data or grid mode was saved, ensure list is empty visually
                anchorData = [];
                renderAnchorTable();
            }
            
            switchTab('calculator'); performCalculation();
        };

        window.loadHistory = function () {
            if (!currentUser) return; const list = document.getElementById('history-list');
            list.innerHTML = '<div class="p-6 text-center text-gray-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Loading...</div>';
            db.collection('artifacts').doc('anchor_app').collection('users').doc(currentUser.uid).collection('history').limit(50).onSnapshot(snap => {
                if (snap.empty) { list.innerHTML = `<div class="p-8 text-center text-gray-400">${t('msg_no_rec')}</div>`; return; }
                let docs = []; historyCache = {};
                snap.forEach(doc => { const data = doc.data(); docs.push({ id: doc.id, ...data }); historyCache[doc.id] = data; });
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                let html = '';
                docs.forEach(d => {
                    const status = d.summary.allPass ? `<span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded">${t('pass')}</span>` : `<span class="text-red-600 font-bold text-xs bg-red-50 px-2 py-1 rounded">${t('fail')}</span>`;
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    html += `<div onclick="restoreFromHistory('${d.id}')" class="p-4 hover:bg-blue-50 flex justify-between items-center border-b cursor-pointer transition active:bg-blue-100">
                                <div><div class="flex items-center gap-2 mb-1">${status}<span class="text-xs font-mono text-gray-500">${date}</span></div>
                                <div class="text-sm font-semibold text-gray-700">T: ${d.inputs.T} | V: ${d.inputs.V}</div>
                                <div class="text-xs text-gray-400 mt-1 flex flex-wrap gap-1"><span class="bg-gray-100 px-1 rounded border">hef: ${d.inputs.hef}</span><span class="bg-gray-100 px-1 rounded border">da: ${d.inputs.da}</span></div></div>
                                <div class="flex items-center gap-4">
                                    <div class="text-eng-primary text-xs font-bold flex items-center">${t('open')} <i class="fa-solid fa-chevron-right ml-1"></i></div>
                                    <button onclick="deleteHistoryItem('${d.id}', event)" class="p-2 text-gray-400 hover:text-red-500 transition-colors">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div></div>`;
                });
                list.innerHTML = html;
            });
        };

        // ==========================================
        //  NEW PDF EXPORT (NATIVE PRINTING)
        // ==========================================
        window.printReport = function () {
            if (!currentData) { alert("Please run the analysis first."); return; }

            const d = currentData;
            const f = currentData.factors;
            const dateStr = new Date().toLocaleDateString();
            const staging = document.getElementById('print-staging');
            const txt = (key) => translations[currentLang][key] || key;

            const showT = d.inputs.T > 0;
            const showV = d.inputs.V > 0;

            // --- 1. DEFINING FORMATTED EQUATIONS ---
            // Concrete Breakout (Tension)
            const e_Nb = `<span class="math-symbol">N<sub>b</sub> = k<sub>c</sub> λ<sub>a</sub> √f'<sub>c</sub> h<sub>ef</sub><sup>1.5</sup></span>`;
            const e_Anc = `<span class="math-symbol">A<sub>Nc</sub> = 2(1.5h<sub>ef</sub>)(C<sub>a1</sub>+S<sub>1</sub>+1.5h<sub>ef</sub>)</span>`;
            const e_psiN = `<span class="math-symbol">ψ<sub>ed,N</sub> = 0.7 + 0.3(c<sub>a,min</sub>/1.5h<sub>ef</sub>)</span>`;
            const e_phiN = `<span class="math-symbol">ϕN<sub>cb</sub> = ϕ (A<sub>Nc</sub>/A<sub>Nco</sub>) ψ<sub>ed,N</sub> ψ<sub>c,N</sub> ψ<sub>cp,N</sub> N<sub>b</sub></span>`;

            // Group Tension
            const e_Ancg = `<span class="math-symbol">A<sub>Nc(g)</sub> = (C<sub>a2</sub>+S<sub>2</sub>+1.5h<sub>ef</sub>)(C<sub>a1</sub>+S<sub>1</sub>+1.5h<sub>ef</sub>)</span>`;
            const e_pecN = `<span class="math-symbol">ψ<sub>ec,N</sub> = 1 / (1 + 2e'<sub>N</sub>/3h<sub>ef</sub>)</span>`;
            const e_phiNg = `<span class="math-symbol">ϕN<sub>cbg</sub> = ϕ (A<sub>Nc(g)</sub>/A<sub>Nco</sub>) ψ<sub>ec,N</sub> ψ<sub>ed,N</sub> ψ<sub>c,N</sub> ψ<sub>cp,N</sub> N<sub>b</sub></span>`;

            // Concrete Breakout (Shear)
            const e_Vb = `<span class="math-symbol">V<sub>b</sub> = min(V<sub>b1</sub>, V<sub>b2</sub>)</span>`;
            const e_Avc = `<span class="math-symbol">A<sub>Vc</sub> = 2(1.5C<sub>a1</sub>)h<sub>a</sub></span>`;
            const e_psiV = `<span class="math-symbol">ψ<sub>ed,V</sub> = 0.7 + 0.3(C<sub>a2</sub>/1.5C<sub>a1</sub>)</span>`;
            const e_phiV = `<span class="math-symbol">ϕV<sub>cb</sub> = ϕ (A<sub>Vc</sub>/A<sub>Vco</sub>) ψ<sub>ed,V</sub> ψ<sub>c,V</sub> ψ<sub>h,V</sub> V<sub>b</sub></span>`;

            // Group Shear
            const e_Avcg = `<span class="math-symbol">A<sub>Vc(g)</sub> = [(3C<sub>a1</sub>)+S<sub>2</sub>]h<sub>a</sub></span>`;
            const e_pecV = `<span class="math-symbol">ψ<sub>ec,V</sub> = 1 / (1 + 2e'<sub>V</sub>/3C<sub>a1</sub>)</span>`;
            const e_phiVg = `<span class="math-symbol">ϕV<sub>cbg</sub> = ϕ (A<sub>Vc(g)</sub>/A<sub>Vco</sub>) ψ<sub>ec,V</sub> ψ<sub>ed,V</sub> ψ<sub>c,V</sub> V<sub>b</sub></span>`;

            // Steel Strength
            const e_Nsa = `<span class="math-symbol">N<sub>sa</sub> = A<sub>se</sub> f<sub>uta</sub></span>`;
            const e_phiNsa = `<span class="math-symbol">ϕN<sub>sa</sub> = ϕ A<sub>se</sub> f<sub>uta</sub></span>`;
            const e_Vsa = `<span class="math-symbol">V<sub>sa</sub> = 0.6 A<sub>se</sub> f<sub>uta</sub></span>`;
            const e_phiVsa = `<span class="math-symbol">ϕV<sub>sa</sub> = ϕ 0.6 A<sub>se</sub> f<sub>uta</sub></span>`;

            // Pullout & Pryout
            const e_Npn = `<span class="math-symbol">N<sub>pn</sub> = ψ<sub>c,P</sub> N<sub>p</sub></span>`;
            const e_phiNpn = `<span class="math-symbol">ϕN<sub>pn</sub> = ϕ ψ<sub>c,P</sub> N<sub>p</sub></span>`;
            const e_Vcp = `<span class="math-symbol">V<sub>cp</sub> = k<sub>cp</sub> N<sub>cp</sub></span>`;
            const e_phiVcp = `<span class="math-symbol">ϕV<sub>cp</sub> = ϕ k<sub>cp</sub> N<sub>cp</sub></span>`;

            // Adhesive Bond
            const e_Nba = `<span class="math-symbol">N<sub>ba</sub> = λ<sub>a</sub> τ<sub>cr</sub> π d<sub>a</sub> h<sub>ef</sub></span>`;
            const e_cNa = `<span class="math-symbol">c<sub>Na</sub> = 10 d<sub>a</sub> √(τ<sub>uncr</sub>/77)</span>`;
            const e_Na = `<span class="math-symbol">N<sub>a</sub> = (A<sub>Na</sub>/A<sub>Nao</sub>) ψ<sub>ed,Na</sub> ψ<sub>cp,Na</sub> N<sub>ba</sub></span>`;
            const e_phiNa = `<span class="math-symbol">ϕN<sub>a</sub> = ϕ N<sub>a</sub></span>`;

            // Side-Face Blowout
            const e_Nsb = `<span class="math-symbol">N<sub>sb</sub> = 42.4 c<sub>a1</sub> √A<sub>brg</sub> λ<sub>a</sub> √f'<sub>c</sub></span>`;
            const e_phiNsb = `<span class="math-symbol">ϕN<sub>sb</sub> = ϕ N<sub>sb</sub></span>`;

            // Shear Lug
            const e_Vbrg = `<span class="math-symbol">V<sub>brg</sub> = 1.7 f'<sub>c</sub> A<sub>ef,sl</sub></span>`;
            const e_Vcbsl = `<span class="math-symbol">V<sub>cb,sl</sub> = (A<sub>Vc,sl</sub>/A<sub>Vco,sl</sub>) ψ<sub>ed,V</sub>... V<sub>b,sl</sub></span>`;


            // --- 2. GENERATING REPORT HTML ---
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 20px;">
                    <div>
                        <h1 style="color: #004a99; font-size: 20pt; margin: 0; font-weight:bold;">${txt('app_title')}</h1>
                        <p style="font-size: 10pt; color: #555; margin: 2px 0 0 0;">${txt('app_subtitle')}</p>
                    </div>
                    <div style="text-align: right; font-size: 9pt; color: #777;">
                        ${dateStr}
                    </div>
                </div>

                ${(d.geo_warnings && d.geo_warnings.length > 0) ? `
                    <div style="background-color:#fee2e2; color:#b91c1c; padding:10px; margin-bottom:20px; border-left:5px solid #ef4444;">
                        <strong>${txt('warn_title')}</strong>
                        <ul>${d.geo_warnings.map(w => `<li>${w}</li>`).join('')}</ul>
                    </div>
                ` : ''}


                <h3>${txt('rpt_layout')} (${currentVizMode.toUpperCase()})</h3>
                <div style="text-align:center; padding: 15px; border: 1px solid #eee; margin-bottom: 20px;">
                    <img src="${currentVizMode === '2d' ? document.getElementById('viz-canvas').toDataURL() : renderer.domElement.toDataURL()}" style="max-width: 100%; border: 1px solid #ccc; height: 200px; object-fit: contain;">
                </div>

                <h2>${txt('sec_mat')}</h2>
                <table>
                    <tr><th>${txt('tbl_param')}</th><th>${txt('tbl_val')}</th><th>${txt('tbl_unit')}</th></tr>
                    <tr><td>${txt('lbl_fc')}</td><td>${d.inputs.fc}</td><td>kgf/cm²</td></tr>
                    <tr><td>${txt('lbl_ha')}</td><td>${d.inputs.ha}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_da')}</td><td>${d.inputs.da}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_hef')}</td><td>${d.inputs.hef}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_cac')}</td><td>${d.inputs.cac}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_ase')}</td><td>${d.inputs.ase}</td><td>cm²</td></tr>
                    <tr><td>${txt('lbl_futa')}</td><td>${d.inputs.futa}</td><td>kgf/cm²</td></tr>
                    <tr><td>${txt('lbl_s1')}</td><td>${d.inputs.s1}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_s2')}</td><td>${d.inputs.s2}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_ca1')}</td><td>${d.inputs.ca1}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_ca1_1')}</td><td>${d.inputs.ca1_1}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_ca2')}</td><td>${d.inputs.ca2}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_t')}</td><td>${d.inputs.T}</td><td>kgf</td></tr>
                    <tr><td>${txt('lbl_v')}</td><td>${d.inputs.V}</td><td>kgf</td></tr>
                    ${d.inputs.is_adhesive ? `<tr><td>${txt('lbl_tsust')}</td><td>${d.inputs.loadT_sust}</td><td>kgf</td></tr>` : ''}
                </table>
                
                <div class="page-break"></div>
                
                <h2>${txt('sec_factors')}</h2>
                <table>
                    <tr><th>${txt('tbl_factor')}</th><th>${txt('tbl_val')}</th><th>${txt('tbl_note')}</th></tr>
                    <tr>
                        <td>${txt('lbl_kc')}</td>
                        <td>${d.inputs.kc_raw === '10' ? txt('opt_cast') : (d.inputs.kc_raw === 'screw' ? txt('opt_screw') : txt('opt_post'))}</td>
                        <td></td>
                    </tr>
                    <tr><td>${txt('lbl_lambda')}</td><td>${d.inputs.lambda}</td><td></td></tr>
                    <tr>
                        <td>${txt('lbl_le')}</td>
                        <td>${d.inputs.le_mode === 'sleeve' ? txt('opt_le2') : (d.inputs.le_mode === 'torque' ? txt('opt_le3') : txt('opt_le1'))}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>${txt('lbl_reinf')}</td>
                        <td>${d.inputs.psi_c_V === 1.2 ? txt('opt_reinf2') : (d.inputs.psi_c_V === 1.4 ? txt('opt_reinf3') : txt('opt_reinf1'))}</td>
                        <td></td>
                    </tr>
                    <tr><td>${txt('lbl_en')}</td><td>${d.inputs.e_prime_n}</td><td>cm</td></tr>
                    <tr><td>${txt('lbl_ev')}</td><td>${d.inputs.e_prime_v}</td><td>cm</td></tr>
                    <tr>
                        <td>${txt('lbl_pull_mode')}</td>
                        <td>${d.inputs.pull_mode === 'hooked' ? txt('opt_hooked') : (d.inputs.pull_mode === 'post' ? txt('opt_post_cert') : txt('opt_headed'))}</td>
                        <td></td>
                    </tr>
                    <tr><td>${txt('lbl_is_adh')}</td><td>${d.inputs.is_adhesive ? txt('val_yes') : txt('val_no')}</td><td></td></tr>
                    <tr>
                        <td>${txt('lbl_cond')}</td>
                        <td>${d.inputs.cond_ab === 'A' ? txt('opt_cond_a') : txt('opt_cond_b')}</td>
                        <td></td>
                    </tr>
                    <tr><td>${txt('lbl_cat')}</td><td>${d.inputs.category}</td><td></td></tr>
                    <tr><td>${txt('lbl_seismic')}</td><td>${d.inputs.is_seismic ? txt('val_yes') : txt('val_no')}</td><td></td></tr>
                    <tr>
                        <td>${txt('lbl_v_dir')}</td>
                        <td>${d.inputs.v_dir === 'para' ? txt('opt_v_para') : txt('opt_v_perp')}</td>
                        <td></td>
                    </tr>
                </table>

                <div class="page-break"></div>`;

            if(showT || showV) {
                html += `
                    <h3>${txt('res_int_title')}</h3>
                    <table>
                        <tr><th>${txt('tbl_res_type')}</th><th>${txt('tbl_val')}</th><th>${txt('tbl_stat')}</th></tr>
                        <tr><td><strong>${txt('res_max_n')}</strong></td><td>${d.calcs.interaction.max_n.toFixed(2)}</td><td>-</td></tr>
                        <tr><td><strong>${txt('res_max_v')}</strong></td><td>${d.calcs.interaction.max_v.toFixed(2)}</td><td>-</td></tr>
                        <tr style="background:${d.calcs.interaction.status === 'OK' || d.calcs.interaction.status.includes('N/A') ? '#e6fffa' : '#fee2e2'}">
                            <td><strong>${txt('res_sum')}</strong></td>
                            <td><strong>${d.calcs.interaction.val.toFixed(2)}</strong></td>
                            <td><strong>${d.calcs.interaction.status}</strong></td>
                        </tr>
                    </table>
                `;
            }

            // --- STEEL STRENGTH SECTION ---
            if(showT || showV) {
                 html += `
                    <h3>${txt('res_s_title')}</h3>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        
                        <tr><td>${txt('res_nsa')}</td><td>${e_Nsa}</td><td>${Math.round(d.calcs.s1.nsa)}</td><td>kgf</td><td>-</td></tr>
                        <tr style="background:#f0f9ff"><td><strong>${txt('res_phi_nsa')}</strong></td><td>${e_phiNsa}</td><td><strong>${Math.round(d.calcs.s1.cap)}</strong></td><td>kgf</td><td><span class="${d.calcs.s1.ok ? 'pass' : 'fail'}">${d.calcs.s1.ok ? txt('pass') : txt('fail')}</span></td></tr>
                        <tr><td><strong>${txt('res_ratio')}</strong></td><td><strong>${txt('tbl_ratio_lbl')}</strong></td><td><strong>${(d.calcs.s1.ratio || 0).toFixed(2)}</strong></td><td><strong>-</strong></td><td>-</td></tr>

                        <tr><td>${txt('res_vsa')}</td><td>${e_Vsa}</td><td>${Math.round(d.calcs.s2.vsa)}</td><td>kgf</td><td>-</td></tr>
                        <tr style="background:#f0f9ff"><td><strong>${txt('res_phi_vsa')}</strong></td><td>${e_phiVsa}</td><td><strong>${Math.round(d.calcs.s2.cap)}</strong></td><td>kgf</td><td><span class="${d.calcs.s2.ok ? 'pass' : 'fail'}">${d.calcs.s2.ok ? txt('pass') : txt('fail')}</span></td></tr>
                        <tr><td><strong>${txt('res_ratio')}</strong></td><td><strong>${txt('tbl_ratio_lbl')}</strong></td><td><strong>${(d.calcs.s2.ratio || 0).toFixed(2)}</strong></td><td><strong>-</strong></td><td>-</td></tr>
                    </table>
                 `;
            }

            // --- PULLOUT & PRYOUT SECTION ---
            if(showT || showV) {
                 html += `
                    <h3>${txt('res_p_title')}</h3>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        
                        <tr><td>${txt('res_npn')}</td><td>${e_Npn}</td><td>${Math.round(d.calcs.pn.npn)}</td><td>kgf</td><td>-</td></tr>
                        <tr style="background:#fffbe6"><td><strong>${txt('res_phi_npn')}</strong></td><td>${e_phiNpn}</td><td><strong>${Math.round(d.calcs.pn.cap)}</strong></td><td>kgf</td><td><span class="${d.calcs.pn.ok ? 'pass' : 'fail'}">${d.calcs.pn.ok ? txt('pass') : txt('fail')}</span></td></tr>
                        <tr><td><strong>${txt('res_ratio')}</strong></td><td><strong>${txt('tbl_ratio_lbl')}</strong></td><td><strong>${(d.calcs.pn.ratio || 0).toFixed(2)}</strong></td><td><strong>-</strong></td><td>-</td></tr>

                        <tr><td>${txt('res_vcp')}</td><td>${e_Vcp}</td><td>${Math.round(d.calcs.cp.vcp)}</td><td>kgf</td><td>-</td></tr>
                        <tr style="background:#fffbe6"><td><strong>${txt('res_phi_vcp')}</strong></td><td>${e_phiVcp}</td><td><strong>${Math.round(d.calcs.cp.cap)}</strong></td><td>kgf</td><td><span class="${d.calcs.cp.ok ? 'pass' : 'fail'}">${d.calcs.cp.ok ? txt('pass') : txt('fail')}</span></td></tr>
                        <tr><td><strong>${txt('res_ratio')}</strong></td><td><strong>${txt('tbl_ratio_lbl')}</strong></td><td><strong>${(d.calcs.cp.ratio || 0).toFixed(2)}</strong></td><td><strong>-</strong></td><td>-</td></tr>
                    </table>
                 `;
            }

            // --- BOND SECTION ---
            if (showT && d.inputs.is_adhesive) {
                html += `
                    <h3>${txt('res_b_title')}</h3>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        <tr><td>${txt('res_nba')}</td><td>${e_Nba}</td><td>${Math.round(d.calcs.bond.nba)}</td><td>kgf</td><td>-</td></tr>
                        <tr><td>${txt('res_cna')}</td><td>${e_cNa}</td><td>${Math.round(d.calcs.bond.cna)}</td><td>cm</td><td>-</td></tr>
                        <tr><td>${txt('res_na')}</td><td>${e_Na}</td><td>${Math.round(d.calcs.bond.na)}</td><td>kgf</td><td>-</td></tr>
                        <tr style="background:#e6f3ff">
                            <td><strong>${txt('res_phi_na')}</strong></td>
                            <td>${e_phiNa}</td>
                            <td><strong>${Math.round(d.calcs.bond.cap)}</strong></td>
                            <td>kgf</td>
                            <td><span class="${d.calcs.bond.ok ? 'pass' : 'fail'}">${d.calcs.bond.ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                            <td><strong>${(d.calcs.bond.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>${txt('res_sust_load')}</td>
                            <td>Load ≤ 0.4φNa</td>
                            <td>${d.inputs.loadT_sust} / ${Math.round(d.calcs.bond.sust_cap)}</td>
                            <td>kgf</td>
                            <td><span class="${d.calcs.bond.sust_ok ? 'pass' : 'fail'}">${d.calcs.bond.sust_ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                    </table>
                `;
            }

            // --- CONCRETE BREAKOUT (TENSION) ---
            if (showT) {
                html += `
                    <h3>${txt('res_t_title')}</h3>
                    <div style="margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Nb_pdf}</div>

                    <h4>${txt('res_t1_sub')}</h4>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        <tr><td>${txt('res_nb')}</td><td>${e_Nb}</td><td>${Math.round(d.calcs.c1.nb)}</td><td>kgf</td><td>-</td></tr>
                        <tr><td>${txt('res_anc')}</td><td>${e_Anc}</td><td>${Math.round(d.calcs.c1.anc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_edge')}</td><td>${e_psiN}</td><td>${f.psi_ed_N.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr><td>${txt('res_psi_cp')}</td><td>${f.psi_cp_N < 1 ? 'ca,min/cac' : '1.0'}</td><td>${f.psi_cp_N.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#e6f3ff">
                            <td><strong>${txt('res_cap')}</strong></td>
                            <td><strong>${e_phiN}</strong></td>
                            <td><strong>${Math.round(d.calcs.c1.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c1.ok ? 'pass' : 'fail'}">${d.calcs.c1.ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                            <td><strong>${(d.calcs.c1.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>

                    <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Ncbg_pdf}</div>
                    <h4>${txt('res_tg_sub')}</h4>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        <tr><td>${txt('res_anc_g')}</td><td>${e_Ancg}</td><td>${Math.round(d.calcs.c3.anc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_ecc')}</td><td>${e_pecN}</td><td>${f.psi_ec_N.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#f9f9e0">
                            <td><strong>${txt('res_cap_g')}</strong></td>
                            <td><strong>${e_phiNg}</strong></td>
                            <td><strong>${Math.round(d.calcs.c3.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c3.ok ? 'pass' : 'fail'}">${d.calcs.c3.ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                            <td><strong>${(d.calcs.c3.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>
                    
                    ${d.calcs.sb.applicable ? `
                        <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #f59e0b"></div>
                        <h4>${txt('res_sb_title')}</h4> <!-- REMOVED HARDCODED (Step 5) -->
                        <table>
                            <tr>
                                <th>${txt('tbl_check')}</th>
                                <th>${txt('tbl_eq')}</th>
                                <th>${txt('tbl_val')}</th>
                                <th>${txt('tbl_stat')}</th>
                            </tr>
                            <tr><td>${txt('res_nsb')}</td><td>${e_Nsb}</td><td>${Math.round(d.calcs.sb.nsb)} kgf</td><td>-</td></tr>
                            <tr style="background:#fff7ed">
                                <td><strong>${txt('res_phi_nsb')}</strong></td>
                                <td>${e_phiNsb}</td>
                                <td><strong>${Math.round(d.calcs.sb.cap)} kgf</strong></td>
                                <td><span class="${d.calcs.sb.ok ? 'pass' : 'fail'}">${d.calcs.sb.ok ? txt('pass') : txt('fail')}</span></td>
                            </tr>
                            <tr>
                                <td><strong>${txt('res_ratio')}</strong></td>
                                <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                                <td><strong>${(d.calcs.sb.ratio || 0).toFixed(2)}</strong></td>
                                <td>-</td>
                            </tr>
                        </table>
                    ` : ''}
                    `;
            }

            // --- CONCRETE BREAKOUT (SHEAR) ---
            if (showV) {
                html += `
                    <h3>${txt('res_v_title')}</h3>
                    <div style="margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Vb_pdf}</div>

                    <h4>${txt('res_v1_sub')}</h4>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        <tr><td>${txt('res_vb')}</td><td>${e_Vb}</td><td>${Math.round(d.calcs.c2.vb)}</td><td>kgf</td><td>-</td></tr>
                        <tr><td>${txt('res_avc')}</td><td>${e_Avc}</td><td>${Math.round(d.calcs.c2.avc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_edge')}</td><td>${e_psiV}</td><td>${f.psi_ed_V.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#e6f3ff">
                            <td><strong>${txt('res_cap')}</strong></td>
                            <td><strong>${e_phiV}</strong></td>
                            <td><strong>${Math.round(d.calcs.c2.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c2.ok ? 'pass' : 'fail'}">${d.calcs.c2.ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                            <td><strong>${(d.calcs.c2.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>
                    
                    ${d.calcs.sl.applicable ? `
                        <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99"></div>
                        <h4>${txt('lbl_is_sl')}</h4>
                        <table>
                             <tr>
                                <th>${txt('tbl_check')}</th>
                                <th>${txt('tbl_eq')}</th>
                                <th>${txt('tbl_val')}</th>
                                <th>${txt('tbl_stat')}</th>
                             </tr>
                             <tr><td>Bearing (Vbrg)</td><td>${e_Vbrg}</td><td>${Math.round(d.calcs.sl.vbrg)} kgf</td><td>-</td></tr>
                             <tr><td>Breakout (Vcb,sl)</td><td>${e_Vcbsl}</td><td>${Math.round(d.calcs.sl.vcbsl)} kgf</td><td>-</td></tr>
                             <tr style="background:#e6f3ff">
                                <td><strong>Capacity</strong></td>
                                <td>min(ϕVbrg, ϕVcb,sl)</td>
                                <td><strong>${Math.round(d.calcs.sl.cap)} kgf</strong></td>
                                <td><span class="${d.calcs.sl.ratio < 1.0 ? 'pass' : 'fail'}">${d.calcs.sl.ratio < 1.0 ? txt('pass') : txt('fail')}</span></td>
                             </tr>
                        </table>
                    ` : ''}

                    <div style="margin-top:10px; margin-bottom:5px; padding-left:5px; border-left:3px solid #004a99">${math_Vcbg_pdf}</div>
                    <h4>${txt('res_vg_sub')}</h4>
                    <table>
                        <tr>
                            <th>${txt('tbl_check')}</th>
                            <th>${txt('tbl_eq')}</th>
                            <th>${txt('tbl_val')}</th>
                            <th>${txt('tbl_unit')}</th>
                            <th>${txt('tbl_stat')}</th>
                        </tr>
                        <tr><td>${txt('res_avc_g')}</td><td>${e_Avcg}</td><td>${Math.round(d.calcs.c4.avc)}</td><td>cm²</td><td>-</td></tr>
                        <tr><td>${txt('res_ecc')}</td><td>${e_pecV}</td><td>${f.psi_ec_V.toFixed(2)}</td><td>-</td><td>-</td></tr>
                        <tr style="background:#f9f9e0">
                            <td><strong>${txt('res_cap_g')}</strong></td>
                            <td><strong>${e_phiVg}</strong></td>
                            <td><strong>${Math.round(d.calcs.c4.cap)}</strong></td>
                            <td><strong>kgf</strong></td>
                            <td><span class="${d.calcs.c4.ok ? 'pass' : 'fail'}">${d.calcs.c4.ok ? txt('pass') : txt('fail')}</span></td>
                        </tr>
                        <tr>
                            <td><strong>${txt('res_ratio')}</strong></td>
                            <td><strong>${txt('tbl_ratio_lbl')}</strong></td>
                            <td><strong>${(d.calcs.c4.ratio || 0).toFixed(2)}</strong></td>
                            <td><strong>-</strong></td>
                            <td>-</td>
                        </tr>
                    </table>
                `;
            }

            html += `
                <div class="report-footer">
                    Generated by Anchor Analysis Web App | ${new Date().getFullYear()}
                </div>
            `;

            staging.innerHTML = html;
            setTimeout(() => {
                window.print();
            }, 500);
        };

        window.switchTab = function (tab) {
            document.getElementById('view-calculator').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            document.getElementById('tab-calculator').classList.remove('border-eng-primary', 'text-eng-primary');
            document.getElementById('tab-history').classList.remove('border-eng-primary', 'text-eng-primary');
            document.getElementById('tab-calculator').classList.add('text-gray-500');
            document.getElementById('tab-history').classList.add('text-gray-500');

            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('border-eng-primary', 'text-eng-primary');
            document.getElementById('tab-' + tab).classList.remove('text-gray-500');

            if (tab === 'history') loadHistory();
        };

        // Initialize UI States
        togglePulloutInputs();
        toggleAdhesive();
        toggleShearLug();
        toggleReinf();
        toggleSeismicDetailing();
        updateCac();
        init3D();
    </script>
</body>
</html>